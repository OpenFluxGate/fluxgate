# FluxGate ê¸°ë°˜ ì§€ì‹

ì´ ë¬¸ì„œëŠ” FluxGateë¥¼ ì´í•´í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ê¸°ë°˜ ì§€ì‹ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

[< ì•„í‚¤í…ì²˜ ê°œìš”ë¡œ ëŒì•„ê°€ê¸°](README.ko.md)

---

## ëª©ì°¨

1. [Rate Limiting ì•Œê³ ë¦¬ì¦˜](#1-rate-limiting-ì•Œê³ ë¦¬ì¦˜)
2. [Redis Lua ìŠ¤í¬ë¦½íŠ¸](#2-redis-lua-ìŠ¤í¬ë¦½íŠ¸)
3. [Redis Pub/Sub](#3-redis-pubsub)
4. [Caffeine ìºì‹œ](#4-caffeine-ìºì‹œ)
5. [Spring Filter ì•„í‚¤í…ì²˜](#5-spring-filter-ì•„í‚¤í…ì²˜)
6. [Token Bucket vs Leaky Bucket](#6-token-bucket-vs-leaky-bucket)

---

## 1. Rate Limiting ì•Œê³ ë¦¬ì¦˜

### 1.1 ì™œ Rate Limitingì´ í•„ìš”í•œê°€?

```
ë¬¸ì œ ìƒí™©:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì•…ì„± ì‚¬ìš©ì or ë²„ê·¸ ìˆëŠ” í´ë¼ì´ì–¸íŠ¸
    â”‚
    â–¼ ì´ˆë‹¹ 10,000 ìš”ì²­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Server    â”‚ â† ê³¼ë¶€í•˜ë¡œ ë‹¤ìš´!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼ ì •ìƒ ì‚¬ìš©ìë„ ì„œë¹„ìŠ¤ ë¶ˆê°€

í•´ê²°:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ëª¨ë“  ìš”ì²­
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rate Limiter   â”‚ â† ì´ˆë‹¹ 100ê°œë§Œ í—ˆìš©
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€ í—ˆìš© â†’ API Server
    â””â”€ ê±°ë¶€ â†’ 429 Too Many Requests
```

### 1.2 ì£¼ìš” ì•Œê³ ë¦¬ì¦˜ ë¹„êµ

#### Fixed Window (ê³ ì • ìœˆë„ìš°)

```
ì‹œê°„: 00:00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º 02:00
      â”‚      Window 1      â”‚      Window 2      â”‚
      â”‚    00:00-01:00     â”‚    01:00-02:00     â”‚
      â”‚                    â”‚                    â”‚
      â”‚  ìš”ì²­ 100ê°œ í—ˆìš©   â”‚  ìš”ì²­ 100ê°œ í—ˆìš©   â”‚
      â”‚  101ë²ˆì§¸ â†’ ê±°ë¶€    â”‚  101ë²ˆì§¸ â†’ ê±°ë¶€    â”‚
```

**ì¥ì :** êµ¬í˜„ ë‹¨ìˆœ, ë©”ëª¨ë¦¬ íš¨ìœ¨ì 

**ë‹¨ì :** ê²½ê³„ ë¬¸ì œ (Boundary Problem)
```
      00:59ì— 100ê°œ + 01:00ì— 100ê°œ
           â”‚              â”‚
           â–¼              â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  1ë¶„ ë™ì•ˆ 200ê°œ í†µê³¼!   â”‚ â† ì˜ë„í•œ ì œí•œì˜ 2ë°°
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### Sliding Window Log (ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ë¡œê·¸)

```
í˜„ì¬ ì‹œê°„: 01:30
ìœˆë„ìš° í¬ê¸°: 1ì‹œê°„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
    â”‚                                        â”‚
  00:30                                    01:30
    â””â”€â”€â”€â”€â”€â”€â”€ ì´ êµ¬ê°„ì˜ ìš”ì²­ë§Œ ì¹´ìš´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì €ì¥ëœ íƒ€ì„ìŠ¤íƒ¬í”„:
[00:25, 00:45, 01:00, 01:15, 01:25]
    â”‚
    â–¼ 00:30 ì´ì „ì€ ì œê±°
[01:00, 01:15, 01:25] â†’ í˜„ì¬ ì¹´ìš´íŠ¸: 3
```

**ì¥ì :** ì •í™•í•œ Rate Limiting

**ë‹¨ì :** ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë†’ìŒ (ëª¨ë“  ìš”ì²­ íƒ€ì„ìŠ¤íƒ¬í”„ ì €ì¥)

---

#### Sliding Window Counter (ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ì¹´ìš´í„°)

```
í˜„ì¬: 01:15 (í˜„ì¬ ìœˆë„ìš°ì˜ 25% ì§€ì )

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì´ì „ ìœˆë„ìš°    â”‚  í˜„ì¬ ìœˆë„ìš°    â”‚
â”‚  00:00-01:00    â”‚  01:00-02:00    â”‚
â”‚                 â”‚                 â”‚
â”‚  80ê°œ ìš”ì²­      â”‚  20ê°œ ìš”ì²­      â”‚
â”‚  Ã— 75% = 60ê°œ   â”‚  Ã— 100% = 20ê°œ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–²
               01:15

ì˜ˆìƒ ì¹´ìš´íŠ¸ = 60 + 20 = 80ê°œ
```

**ì¥ì :** ì •í™•ë„ì™€ íš¨ìœ¨ì„±ì˜ ê· í˜•

**ë‹¨ì :** ì™„ë²½íˆ ì •í™•í•˜ì§€ëŠ” ì•ŠìŒ (ê·¼ì‚¬ì¹˜)

---

#### Token Bucket (í† í° ë²„í‚·) â­ FluxGate ì±„íƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Token Bucket                       â”‚
â”‚                                                      â”‚
â”‚   ìš©ëŸ‰ (Capacity): 100ê°œ                             â”‚
â”‚   ë¦¬í•„ ì†ë„: 10ê°œ/ì´ˆ                                  â”‚
â”‚                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ â— â— â— â— â— â— â— â—‹ â—‹ â—‹   (í˜„ì¬ 70ê°œ)        â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚            â”‚                      â–²                  â”‚
â”‚            â–¼                      â”‚                  â”‚
â”‚       ìš”ì²­ ì‹œ 1ê°œ ì†Œë¹„        ì‹œê°„ ì§€ë‚˜ë©´ ë¦¬í•„       â”‚
â”‚                                                      â”‚
â”‚   í† í° > 0  â†’ í—ˆìš© âœ“                                â”‚
â”‚   í† í° = 0  â†’ ê±°ë¶€ âœ—                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**íŠ¹ì§•:**
- **ë²„ìŠ¤íŠ¸ í—ˆìš©**: ìˆœê°„ì ìœ¼ë¡œ ìš©ëŸ‰ë§Œí¼ ìš”ì²­ ê°€ëŠ¥
- **í‰ê·  ì†ë„ ì œí•œ**: ì¥ê¸°ì ìœ¼ë¡œ ë¦¬í•„ ì†ë„ë¡œ ìˆ˜ë ´
- **ë©”ëª¨ë¦¬ íš¨ìœ¨ì **: í† í° ìˆ˜ + ë§ˆì§€ë§‰ ë¦¬í•„ ì‹œê°„ë§Œ ì €ì¥

---

#### Leaky Bucket (ëˆ„ìˆ˜ ë²„í‚·)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Leaky Bucket                       â”‚
â”‚                                                      â”‚
â”‚   ìš”ì²­ ë“¤ì–´ì˜´                                        â”‚
â”‚       â†“                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ â–£ â–£ â–£ â–£ â–£ â–£ â–£ â–£   (íì— ëŒ€ê¸° ì¤‘)          â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                              â”‚
â”‚                       â†“ ì¼ì •í•œ ì†ë„ë¡œ ì²˜ë¦¬ (leak)    â”‚
â”‚                   â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚                    ì²˜ë¦¬ë¨                            â”‚
â”‚                                                      â”‚
â”‚   í ê°€ë“ ì°¸ â†’ ìƒˆ ìš”ì²­ ê±°ë¶€                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**íŠ¹ì§•:**
- **ì¶œë ¥ ì†ë„ ì¼ì •**: íŠ¸ë˜í”½ ì„±í˜• (Traffic Shaping)
- **ì§€ì—° ë°œìƒ**: íì—ì„œ ëŒ€ê¸°í•´ì•¼ í•¨

---

### 1.3 ì•Œê³ ë¦¬ì¦˜ ì„ íƒ ê°€ì´ë“œ

| ìƒí™© | ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ | ì´ìœ  |
|------|-------------|------|
| API ê³¼ê¸ˆ (ì •í™•í•œ ì¹´ìš´íŠ¸) | Sliding Window Log | ì •í™•ë„ ìµœìš°ì„  |
| ì¼ë°˜ API Rate Limit | **Token Bucket** | ë²„ìŠ¤íŠ¸ í—ˆìš© + ê°„ë‹¨ |
| DB ë³´í˜¸, íŠ¸ë˜í”½ í‰íƒ„í™” | Leaky Bucket | ì¼ì •í•œ ì²˜ë¦¬ëŸ‰ |
| ë‹¨ìˆœí•œ êµ¬í˜„ í•„ìš” | Fixed Window | êµ¬í˜„ ì‰¬ì›€ |

---

## 2. Redis Lua ìŠ¤í¬ë¦½íŠ¸

### 2.1 ì™œ Lua ìŠ¤í¬ë¦½íŠ¸ì¸ê°€?

**ë¬¸ì œ: Race Condition**

```
ì„œë²„ A                          ì„œë²„ B
   â”‚                               â”‚
   â”œâ”€ GET tokens â†’ 5               â”‚
   â”‚                               â”œâ”€ GET tokens â†’ 5
   â”œâ”€ tokens - 1 = 4               â”‚
   â”‚                               â”œâ”€ tokens - 1 = 4
   â”œâ”€ SET tokens 4                 â”‚
   â”‚                               â”œâ”€ SET tokens 4
   â–¼                               â–¼

ê²°ê³¼: 2ë²ˆ ì†Œë¹„í–ˆëŠ”ë° 1ê°œë§Œ ê°ì†Œ! (ë²„ê·¸)
```

**í•´ê²°: Lua ìŠ¤í¬ë¦½íŠ¸ = ì›ìì  ì‹¤í–‰**

```
ì„œë²„ A                          Redis (ì‹±ê¸€ ìŠ¤ë ˆë“œ)
   â”‚                               â”‚
   â”œâ”€ EVALSHA script â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ ì‹¤í–‰
   â”‚                               â”‚ (ì¤‘ê°„ì— ëŠê¸°ì§€ ì•ŠìŒ)
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê²°ê³¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                               â”‚
ì„œë²„ B                              â”‚
   â”œâ”€ EVALSHA script â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
   â”‚                               â”‚
```

RedisëŠ” **ì‹±ê¸€ ìŠ¤ë ˆë“œ**ì´ë¯€ë¡œ Lua ìŠ¤í¬ë¦½íŠ¸ëŠ” **ì›ìì (Atomic)**ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.

---

### 2.2 Lua ê¸°ë³¸ ë¬¸ë²•

```lua
-- ë³€ìˆ˜ ì„ ì–¸
local count = 10
local name = "fluxgate"

-- ì¡°ê±´ë¬¸
if count > 5 then
    return "high"
elseif count > 0 then
    return "low"
else
    return "zero"
end

-- ë°˜ë³µë¬¸
for i = 1, 10 do
    print(i)
end

-- í•¨ìˆ˜
local function add(a, b)
    return a + b
end

-- í…Œì´ë¸” (ë°°ì—´/ë§µ)
local arr = {1, 2, 3}           -- ë°°ì—´ (1ë¶€í„° ì‹œì‘!)
local map = {name = "flux"}     -- ë§µ

print(arr[1])      -- 1 (LuaëŠ” 1ë¶€í„°!)
print(map.name)    -- "flux"
```

---

### 2.3 Redisì—ì„œ Lua ì‚¬ìš©

```lua
-- KEYS: ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” Redis í‚¤
-- ARGV: ìŠ¤í¬ë¦½íŠ¸ì— ì „ë‹¬í•˜ëŠ” ì¸ì

-- ì˜ˆì‹œ: EVALSHA sha1 1 mykey 10
-- KEYS[1] = "mykey"
-- ARGV[1] = "10"

local key = KEYS[1]
local increment = tonumber(ARGV[1])

-- Redis ëª…ë ¹ì–´ í˜¸ì¶œ
local current = redis.call('GET', key)
current = tonumber(current) or 0

local new_value = current + increment
redis.call('SET', key, new_value)

return new_value
```

---

### 2.4 EVAL vs EVALSHA

```
EVAL (ëŠë¦¼)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ë§¤ë²ˆ ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ ì „ì†¡

Client: EVAL "local x = redis.call('GET', KEYS[1]) ..." 1 mykey
                    â””â”€â”€â”€â”€â”€â”€â”€ ê¸´ ìŠ¤í¬ë¦½íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”˜


EVALSHA (ë¹ ë¦„) â† FluxGate ì‚¬ìš©
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. ìµœì´ˆ 1íšŒ: SCRIPT LOAD "ìŠ¤í¬ë¦½íŠ¸..." â†’ SHA: "a1b2c3..."
2. ì´í›„: EVALSHA "a1b2c3..." 1 mykey
              â””â”€ 40ë°”ì´íŠ¸ í•´ì‹œë§Œ ì „ì†¡
```

---

### 2.5 FluxGateì˜ Token Bucket Lua ìŠ¤í¬ë¦½íŠ¸

```lua
-- token_bucket_consume.lua (ê°„ëµí™”)

local bucket_key = KEYS[1]
local capacity = tonumber(ARGV[1])
local window_nanos = tonumber(ARGV[2])
local permits = tonumber(ARGV[3])

-- Redis ì„œë²„ ì‹œê°„ ì‚¬ìš© (í´ëŸ­ ë“œë¦¬í”„íŠ¸ ë°©ì§€)
local time_info = redis.call('TIME')
local now_nanos = time_info[1] * 1000000000 + time_info[2] * 1000

-- í˜„ì¬ ìƒíƒœ ì½ê¸°
local data = redis.call('HMGET', bucket_key, 'tokens', 'last_refill')
local tokens = tonumber(data[1]) or capacity
local last_refill = tonumber(data[2]) or now_nanos

-- í† í° ë¦¬í•„ ê³„ì‚° (ì •ìˆ˜ ì—°ì‚°ë§Œ ì‚¬ìš©)
local elapsed = now_nanos - last_refill
local refill = math.floor((elapsed * capacity) / window_nanos)
tokens = math.min(capacity, tokens + refill)

-- ì†Œë¹„ ì‹œë„
if tokens >= permits then
    tokens = tokens - permits
    redis.call('HMSET', bucket_key, 'tokens', tokens, 'last_refill', now_nanos)
    redis.call('EXPIRE', bucket_key, 86400)  -- TTL ì„¤ì •
    return {1, tokens, 0}  -- í—ˆìš©
else
    local wait = math.ceil((permits - tokens) * window_nanos / capacity)
    return {0, tokens, wait}  -- ê±°ë¶€
end
```

---

### 2.6 NOSCRIPT ì—ëŸ¬ ì²˜ë¦¬

```
ë¬¸ì œ: Redis ì¬ì‹œì‘ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ìºì‹œ ì‚¬ë¼ì§

EVALSHA "a1b2c3..." â†’ NOSCRIPT ì—ëŸ¬!

í•´ê²° (FluxGate êµ¬í˜„):
1. EVALSHA ì‹œë„
2. NOSCRIPT ì—ëŸ¬ ë°œìƒ
3. EVALë¡œ í´ë°± (ë™ì‘ì€ í•¨)
4. ìŠ¤í¬ë¦½íŠ¸ ë‹¤ì‹œ ë¡œë“œ (ë‹¤ìŒ ìš”ì²­ë¶€í„° EVALSHA ì‚¬ìš©)
```

---

## 3. Redis Pub/Sub

### 3.1 ê°œë…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Redis Server                          â”‚
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚              Channel: "fluxgate:reload"              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â–²                    â”‚                              â”‚
â”‚         â”‚ PUBLISH            â”‚ ë©”ì‹œì§€ ì „ë‹¬                   â”‚
â”‚         â”‚                    â–¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Publisher â”‚    â”‚   Subscribers    â”‚
    â”‚ (Admin)   â”‚    â”‚ (App Instances)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                  â”‚
                     â”‚  Instance 1      â”‚
                     â”‚  Instance 2      â”‚
                     â”‚  Instance 3      â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ì‚¬ìš© ì˜ˆì‹œ

**Publisher (ë©”ì‹œì§€ ë°œí–‰)**
```bash
PUBLISH fluxgate:reload '{"ruleSetId": "api-limits", "action": "RELOAD"}'
```

**Subscriber (ë©”ì‹œì§€ êµ¬ë…)**
```bash
SUBSCRIBE fluxgate:reload
# ë©”ì‹œì§€ê°€ ì˜¤ë©´ ìë™ìœ¼ë¡œ ìˆ˜ì‹ 
```

### 3.3 FluxGateì—ì„œì˜ í™œìš©

```
Adminì´ ê·œì¹™ ë³€ê²½
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PUBLISH ë©”ì‹œì§€ ë°œí–‰  â”‚
â”‚ Channel: reload     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ Redisê°€ ëª¨ë“  êµ¬ë…ìì—ê²Œ ì „ë‹¬
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â–¼             â–¼              â–¼
Instance 1  Instance 2  Instance 3
    â”‚             â”‚            â”‚
    â–¼             â–¼            â–¼
ìºì‹œ ê°±ì‹      ìºì‹œ ê°±ì‹     ìºì‹œ ê°±ì‹ 
ë²„í‚· ë¦¬ì…‹     ë²„í‚· ë¦¬ì…‹    ë²„í‚· ë¦¬ì…‹
```

### 3.4 Pub/Sub vs Polling

| ë°©ì‹ | ì¥ì  | ë‹¨ì  |
|------|------|------|
| **Polling** | êµ¬í˜„ ë‹¨ìˆœ | ì§€ì—° ë°œìƒ (í´ë§ ì£¼ê¸°) |
| **Pub/Sub** | ì‹¤ì‹œê°„ ë™ê¸°í™” | ì—°ê²° ê´€ë¦¬ í•„ìš” |

```yaml
# FluxGate ì„¤ì •
fluxgate:
  reload:
    strategy: REDIS_PUBSUB   # ë˜ëŠ” POLLING
    polling-interval: 30s    # POLLINGì¼ ë•Œ ì‚¬ìš©
```

---

## 4. Caffeine ìºì‹œ

### 4.1 ì™œ ìºì‹œê°€ í•„ìš”í•œê°€?

```
ìºì‹œ ì—†ì„ ë•Œ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ìš”ì²­ 1 â†’ MongoDB ì¡°íšŒ (10ms)
ìš”ì²­ 2 â†’ MongoDB ì¡°íšŒ (10ms)
ìš”ì²­ 3 â†’ MongoDB ì¡°íšŒ (10ms)
...
ìš”ì²­ 1000 â†’ MongoDB ì¡°íšŒ (10ms)
ì´: 10,000ms

ìºì‹œ ìˆì„ ë•Œ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ìš”ì²­ 1 â†’ MongoDB ì¡°íšŒ (10ms) â†’ ìºì‹œ ì €ì¥
ìš”ì²­ 2 â†’ ìºì‹œ íˆíŠ¸ (0.1ms)
ìš”ì²­ 3 â†’ ìºì‹œ íˆíŠ¸ (0.1ms)
...
ìš”ì²­ 1000 â†’ ìºì‹œ íˆíŠ¸ (0.1ms)
ì´: ~110ms (90ë°° ë¹ ë¦„)
```

### 4.2 Caffeineì´ë€?

Javaì˜ ê³ ì„±ëŠ¥ ë¡œì»¬ ìºì‹œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤.

```java
Cache<String, RateLimitRuleSet> cache = Caffeine.newBuilder()
    .maximumSize(1000)                    // ìµœëŒ€ 1000ê°œ í•­ëª©
    .expireAfterWrite(Duration.ofMinutes(5))  // 5ë¶„ í›„ ë§Œë£Œ
    .recordStats()                        // í†µê³„ ìˆ˜ì§‘
    .build();

// ì €ì¥
cache.put("api-limits", ruleSet);

// ì¡°íšŒ
RateLimitRuleSet cached = cache.getIfPresent("api-limits");

// ì—†ìœ¼ë©´ ë¡œë“œ
RateLimitRuleSet loaded = cache.get("api-limits", key -> loadFromDB(key));
```

### 4.3 Eviction ì •ì±…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Caffeine Cache                          â”‚
â”‚                                                            â”‚
â”‚   Eviction (ì œê±°) ì •ì±…:                                    â”‚
â”‚                                                            â”‚
â”‚   1. Size-based (í¬ê¸° ê¸°ë°˜)                                â”‚
â”‚      â””â”€ maximumSize(1000) â†’ 1000ê°œ ì´ˆê³¼ ì‹œ ì œê±°            â”‚
â”‚                                                            â”‚
â”‚   2. Time-based (ì‹œê°„ ê¸°ë°˜)                                â”‚
â”‚      â”œâ”€ expireAfterWrite(5min) â†’ ì“´ í›„ 5ë¶„ ì§€ë‚˜ë©´ ë§Œë£Œ     â”‚
â”‚      â””â”€ expireAfterAccess(5min) â†’ ì ‘ê·¼ í›„ 5ë¶„ ì§€ë‚˜ë©´ ë§Œë£Œ  â”‚
â”‚                                                            â”‚
â”‚   3. Reference-based (ì°¸ì¡° ê¸°ë°˜)                           â”‚
â”‚      â””â”€ weakKeys(), weakValues() â†’ GCê°€ ìˆ˜ê±° ê°€ëŠ¥         â”‚
â”‚                                                            â”‚
â”‚   ì œê±° ì•Œê³ ë¦¬ì¦˜: Window TinyLFU (ë†’ì€ íˆíŠ¸ìœ¨)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 Window TinyLFU

Caffeineì˜ í•µì‹¬ ì•Œê³ ë¦¬ì¦˜ì…ë‹ˆë‹¤.

```
ì „í†µì ì¸ LRU (Least Recently Used):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê°€ì¥ ì˜¤ë˜ ì‚¬ìš© ì•ˆ ëœ í•­ëª© ì œê±°
ë¬¸ì œ: í•œ ë²ˆ ë§ì´ ì‚¬ìš©ëœ í•­ëª©ë„ ì ì‹œ ì•ˆ ì“°ë©´ ì œê±°ë¨

Window TinyLFU:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ë¹ˆë„(Frequency) + ìµœê·¼ì„±(Recency) ì¡°í•©
ë” ìŠ¤ë§ˆíŠ¸í•œ ì œê±° ê²°ì •

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Window TinyLFU                    â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Window  â”‚â”€â”€â”€â”€â–¶â”‚      Main Cache          â”‚   â”‚
â”‚  â”‚ (1%)    â”‚     â”‚       (99%)              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                    â”‚                    â”‚
â”‚       â–¼                    â–¼                    â”‚
â”‚  ìƒˆ í•­ëª© ì§„ì…         ë¹ˆë„ ê¸°ë°˜ ì œê±°             â”‚
â”‚                     (TinyLFU ìŠ¤ì¼€ì¹˜)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.5 FluxGateì—ì„œì˜ ì‚¬ìš©

```java
// FluxGateì˜ RuleCache êµ¬í˜„
@Component
public class CaffeineRuleCache implements RuleCache {

    private final Cache<String, RateLimitRuleSet> cache;

    public CaffeineRuleCache(FluxgateProperties props) {
        this.cache = Caffeine.newBuilder()
            .maximumSize(props.getCache().getMaxSize())      // ê¸°ë³¸ 1000
            .expireAfterWrite(props.getCache().getTtl())     // ê¸°ë³¸ 5ë¶„
            .recordStats()
            .build();
    }

    @Override
    public Optional<RateLimitRuleSet> get(String ruleSetId) {
        return Optional.ofNullable(cache.getIfPresent(ruleSetId));
    }

    @Override
    public void put(String ruleSetId, RateLimitRuleSet ruleSet) {
        cache.put(ruleSetId, ruleSet);
    }

    @Override
    public void invalidate(String ruleSetId) {
        cache.invalidate(ruleSetId);  // Hot Reload ì‹œ í˜¸ì¶œ
    }
}
```

---

## 5. Spring Filter ì•„í‚¤í…ì²˜

### 5.1 Filter Chain ê°œë…

```
HTTP ìš”ì²­
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Filter Chain                            â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Filter 1 â”‚â”€â–¶â”‚ Filter 2 â”‚â”€â–¶â”‚ Filter 3 â”‚â”€â–¶â”‚ Servlet  â”‚    â”‚
â”‚  â”‚ (ì¸ì¦)   â”‚  â”‚ (Rate   â”‚  â”‚ (ë¡œê¹…)   â”‚  â”‚(Controller)â”‚   â”‚
â”‚  â”‚          â”‚  â”‚  Limit) â”‚  â”‚          â”‚  â”‚          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚              â”‚             â”‚             â”‚          â”‚
â”‚       â–¼              â–¼             â–¼             â–¼          â”‚
â”‚   doFilter()    doFilter()    doFilter()    service()       â”‚
â”‚       â”‚              â”‚             â”‚             â”‚          â”‚
â”‚       â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   ì‘ë‹µ ë°˜í™˜                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
HTTP ì‘ë‹µ
```

### 5.2 Filter ì¸í„°í˜ì´ìŠ¤

```java
public interface Filter {

    default void init(FilterConfig filterConfig) throws ServletException {}

    void doFilter(
        ServletRequest request,
        ServletResponse response,
        FilterChain chain
    ) throws IOException, ServletException;

    default void destroy() {}
}
```

### 5.3 Filter ë™ì‘ íë¦„

```java
public class MyFilter implements Filter {

    @Override
    public void doFilter(
            ServletRequest request,
            ServletResponse response,
            FilterChain chain) throws IOException, ServletException {

        // ===== ì „ì²˜ë¦¬ (ìš”ì²­ ë“¤ì–´ì˜¬ ë•Œ) =====
        System.out.println("Before request processing");

        // ë‹¤ìŒ í•„í„°ë¡œ ì „ë‹¬ (ë˜ëŠ” ì„œë¸”ë¦¿ìœ¼ë¡œ)
        chain.doFilter(request, response);

        // ===== í›„ì²˜ë¦¬ (ì‘ë‹µ ë‚˜ê°ˆ ë•Œ) =====
        System.out.println("After request processing");
    }
}
```

```
ì‹¤í–‰ ìˆœì„œ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ìš”ì²­ â†’ Filter1 ì „ì²˜ë¦¬
           â†’ Filter2 ì „ì²˜ë¦¬
                  â†’ Filter3 ì „ì²˜ë¦¬
                         â†’ Servlet ì²˜ë¦¬
                  â† Filter3 í›„ì²˜ë¦¬
           â† Filter2 í›„ì²˜ë¦¬
     â† Filter1 í›„ì²˜ë¦¬
â† ì‘ë‹µ
```

### 5.4 Filter ë“±ë¡ ë°©ë²•

**ë°©ë²• 1: @Component (Spring Boot)**
```java
@Component
@Order(1)  // ìˆœì„œ ì§€ì •
public class RateLimitFilter implements Filter {
    // ...
}
```

**ë°©ë²• 2: FilterRegistrationBean**
```java
@Configuration
public class FilterConfig {

    @Bean
    public FilterRegistrationBean<RateLimitFilter> rateLimitFilter() {
        FilterRegistrationBean<RateLimitFilter> registration =
            new FilterRegistrationBean<>();

        registration.setFilter(new RateLimitFilter());
        registration.addUrlPatterns("/api/*");  // íŠ¹ì • ê²½ë¡œë§Œ
        registration.setOrder(1);

        return registration;
    }
}
```

### 5.5 FluxGate Rate Limit Filter

```java
public class FluxgateRateLimitFilter implements Filter {

    private final FluxgateRateLimitHandler handler;
    private final List<String> includePatterns;
    private final List<String> excludePatterns;

    @Override
    public void doFilter(
            ServletRequest request,
            ServletResponse response,
            FilterChain chain) throws IOException, ServletException {

        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;

        String path = httpRequest.getRequestURI();

        // 1. ì œì™¸ íŒ¨í„´ ì²´í¬
        if (shouldExclude(path)) {
            chain.doFilter(request, response);
            return;
        }

        // 2. RequestContext ìƒì„±
        RequestContext context = RequestContext.builder()
            .clientIp(getClientIp(httpRequest))
            .method(httpRequest.getMethod())
            .endpoint(path)
            .build();

        // 3. Rate Limit ì²´í¬
        RateLimitResponse result = handler.tryConsume(context, ruleSetId);

        // 4. ì‘ë‹µ í—¤ë” ì¶”ê°€
        httpResponse.setHeader("X-RateLimit-Remaining",
            String.valueOf(result.getRemainingTokens()));

        // 5. í—ˆìš©/ê±°ë¶€ ê²°ì •
        if (result.isAllowed()) {
            chain.doFilter(request, response);  // ë‹¤ìŒìœ¼ë¡œ ì „ë‹¬
        } else {
            httpResponse.setStatus(429);  // Too Many Requests
            httpResponse.setHeader("Retry-After",
                String.valueOf(result.getRetryAfterMs() / 1000));
            httpResponse.getWriter().write("Rate limit exceeded");
        }
    }
}
```

### 5.6 Filter vs Interceptor vs AOP

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ìš”ì²­ ì²˜ë¦¬ ìˆœì„œ                           â”‚
â”‚                                                                â”‚
â”‚  HTTP ìš”ì²­                                                     â”‚
â”‚      â”‚                                                         â”‚
â”‚      â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Filter (Servlet)                       â”‚ â”‚
â”‚  â”‚  - Servlet ìŠ¤í™                                           â”‚ â”‚
â”‚  â”‚  - Spring ì™¸ë¶€ì—ì„œë„ ë™ì‘                                  â”‚ â”‚
â”‚  â”‚  - Request/Response ì§ì ‘ ì¡°ì‘ ê°€ëŠ¥                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚      â”‚                                                         â”‚
â”‚      â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                 Interceptor (Spring MVC)                  â”‚ â”‚
â”‚  â”‚  - Spring MVC ìŠ¤í™                                        â”‚ â”‚
â”‚  â”‚  - Handler ì •ë³´ ì ‘ê·¼ ê°€ëŠ¥                                  â”‚ â”‚
â”‚  â”‚  - preHandle, postHandle, afterCompletion                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚      â”‚                                                         â”‚
â”‚      â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      AOP (Spring)                         â”‚ â”‚
â”‚  â”‚  - ë©”ì„œë“œ ë ˆë²¨                                             â”‚ â”‚
â”‚  â”‚  - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ê°€ê¹Œì›€                                   â”‚ â”‚
â”‚  â”‚  - @Before, @After, @Around                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚      â”‚                                                         â”‚
â”‚      â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   Controller                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| êµ¬ë¶„ | Filter | Interceptor | AOP |
|------|--------|-------------|-----|
| **ìŠ¤í™** | Servlet | Spring MVC | Spring |
| **ë ˆë²¨** | HTTP ìš”ì²­/ì‘ë‹µ | Handler | ë©”ì„œë“œ |
| **ì ‘ê·¼ ê°€ëŠ¥** | Request, Response | Handler, ModelAndView | JoinPoint |
| **ì‚¬ìš© ì‚¬ë¡€** | ì¸ì¦, ë¡œê¹…, **Rate Limit** | ê¶Œí•œ, ë¡œê¹… | íŠ¸ëœì­ì…˜, ë¡œê¹… |

**FluxGateê°€ Filterë¥¼ ì„ íƒí•œ ì´ìœ :**
- HTTP ë ˆë²¨ì—ì„œ ì¡°ê¸° ì°¨ë‹¨ (ë¶ˆí•„ìš”í•œ ì²˜ë¦¬ ë°©ì§€)
- Request/Response ì§ì ‘ ì œì–´ ê°€ëŠ¥
- Spring ì™¸ì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥

---

## 6. Token Bucket vs Leaky Bucket

### 6.1 ë™ì‘ ë¹„êµ

```
ì‹œë‚˜ë¦¬ì˜¤: ê²°ì œ API (10 req/sec ì œí•œ)
ì‚¬ìš©ìê°€ 0ì´ˆì— 10ê°œ ìš”ì²­ì„ ë™ì‹œì— ë³´ëƒ„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Token Bucket                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0.0ì´ˆ: 10ê°œ ìš”ì²­ â†’ 10ê°œ ëª¨ë‘ ì¦‰ì‹œ í†µê³¼ âœ…                     â”‚
â”‚ 0.1ì´ˆ: 1ê°œ ìš”ì²­ â†’ í† í° ì—†ìŒ, ê±°ë¶€ âŒ                         â”‚
â”‚ 1.0ì´ˆ: í† í° ë¦¬í•„ â†’ ë‹¤ì‹œ 10ê°œ ê°€ëŠ¥                            â”‚
â”‚                                                             â”‚
â”‚ ê²°ê³¼: ì„œë²„ê°€ ìˆœê°„ì ìœ¼ë¡œ 10ê°œ ë™ì‹œ ì²˜ë¦¬í•´ì•¼ í•¨ ğŸ’¥              â”‚
â”‚ ì¥ì : ì‚¬ìš©ì ì‘ë‹µ ë¹ ë¦„                                       â”‚
â”‚ ë‹¨ì : ì„œë²„ ë¶€í•˜ ìŠ¤íŒŒì´í¬ ë°œìƒ ê°€ëŠ¥                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaky Bucket                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0.0ì´ˆ: 10ê°œ ìš”ì²­ â†’ 1ê°œ í†µê³¼, 9ê°œ í ëŒ€ê¸°                     â”‚
â”‚ 0.1ì´ˆ: íì—ì„œ 1ê°œ ì²˜ë¦¬ â†’ 8ê°œ ëŒ€ê¸°                            â”‚
â”‚ 0.2ì´ˆ: íì—ì„œ 1ê°œ ì²˜ë¦¬ â†’ 7ê°œ ëŒ€ê¸°                            â”‚
â”‚ ...                                                         â”‚
â”‚ 0.9ì´ˆ: íì—ì„œ 1ê°œ ì²˜ë¦¬ â†’ 0ê°œ ëŒ€ê¸°                            â”‚
â”‚                                                             â”‚
â”‚ ê²°ê³¼: ì„œë²„ëŠ” í•­ìƒ 1ê°œì”©ë§Œ ì²˜ë¦¬ âœ…                             â”‚
â”‚ ì¥ì : ì„œë²„ ë¶€í•˜ ì¼ì •                                         â”‚
â”‚ ë‹¨ì : ì‚¬ìš©ì ì‘ë‹µ ì§€ì—° (ìµœëŒ€ 0.9ì´ˆ ëŒ€ê¸°)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ì–¸ì œ ì–´ë–¤ ê²ƒì„ ì‚¬ìš©?

| ìƒí™© | ì¶”ì²œ | ì´ìœ  |
|------|------|------|
| API Gateway | Token Bucket | ë¹ ë¥¸ ì‘ë‹µì´ ì‚¬ìš©ì ê²½í—˜ì— ì¤‘ìš” |
| DB ë³´í˜¸ | Leaky Bucket | ì¼ì •í•œ ì²˜ë¦¬ëŸ‰ìœ¼ë¡œ DB ë³´í˜¸ |
| ê²°ì œ API | Token Bucket | ì¦‰ê°ì ì¸ í”¼ë“œë°± í•„ìš” |
| ë°°ì¹˜ ì‘ì—… í | Leaky Bucket | ì²˜ë¦¬ëŸ‰ í‰íƒ„í™” |

### 6.3 FluxGateì˜ ì„ íƒ

FluxGateëŠ” **Token Bucket**ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤:

1. **API Gateway ìš©ë„** â†’ ë¹ ë¥¸ ì‘ë‹µ ì¤‘ìš”
2. **O(1) ì‹œê°„ë³µì¡ë„** â†’ ê³ ì„±ëŠ¥
3. **Redis Lua ìŠ¤í¬ë¦½íŠ¸ë¡œ ì›ìì  ì²˜ë¦¬ ê°€ëŠ¥**
4. **Multi-Band ì§€ì›** (10/ì´ˆ + 100/ë¶„ + 1000/ì‹œê°„)

```java
RateLimitRule.builder()
    .addBand(10, Duration.ofSeconds(1))    // ì´ˆë‹¹ 10ê°œ
    .addBand(100, Duration.ofMinutes(1))   // ë¶„ë‹¹ 100ê°œ
    .addBand(1000, Duration.ofHours(1))    // ì‹œê°„ë‹¹ 1000ê°œ
    .build();
```

---

## ê´€ë ¨ ë¬¸ì„œ

- [ì•„í‚¤í…ì²˜ ê°œìš”](README.ko.md)
- [RateLimiter Layer Deep Dive](deep-dive/ratelimiter-layer.ko.md)
- [Storage Layer Deep Dive](deep-dive/storage-layer.ko.md)
- [Hot Reload Deep Dive](deep-dive/hot-reload.ko.md)
