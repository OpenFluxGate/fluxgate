# RateLimiter Layer Deep Dive

ì´ ë¬¸ì„œëŠ” FluxGateì˜ RateLimiter Layerë¥¼ **ì‹¤ì œ ì†ŒìŠ¤ì½”ë“œ**ì™€ í•¨ê»˜ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.

[< ì•„í‚¤í…ì²˜ ê°œìš”ë¡œ ëŒì•„ê°€ê¸°](../README.ko.md)

---

## ëª©ì°¨

1. [Rate Limiting ì•Œê³ ë¦¬ì¦˜ ë¹„êµ](#1-rate-limiting-ì•Œê³ ë¦¬ì¦˜-ë¹„êµ)
2. [RateLimiter ì¸í„°í˜ì´ìŠ¤](#2-ratelimiter-ì¸í„°í˜ì´ìŠ¤)
3. [Bucket4jRateLimiter](#3-bucket4jratelimiter)
4. [Redis Lua ìŠ¤í¬ë¦½íŠ¸ (ë¶„ì‚° í™˜ê²½)](#4-redis-lua-ìŠ¤í¬ë¦½íŠ¸-ë¶„ì‚°-í™˜ê²½)

---

## 1. Rate Limiting ì•Œê³ ë¦¬ì¦˜ ë¹„êµ

Rate Limitingì„ êµ¬í˜„í•˜ëŠ” ëŒ€í‘œì ì¸ ì•Œê³ ë¦¬ì¦˜ë“¤ì„ ë¹„êµí•©ë‹ˆë‹¤.

### 1.1 Fixed Window (ê³ ì • ìœˆë„ìš°)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Window 1      â”‚ â”‚   Window 2      â”‚ â”‚   Window 3      â”‚
â”‚   00:00-01:00   â”‚ â”‚   01:00-02:00   â”‚ â”‚   02:00-03:00   â”‚
â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚
â”‚   Count: 100    â”‚ â”‚   Count: 0      â”‚ â”‚   Count: 50     â”‚
â”‚   Limit: 100    â”‚ â”‚   Limit: 100    â”‚ â”‚   Limit: 100    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì¥ì :**
- êµ¬í˜„ì´ ë‹¨ìˆœí•¨
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì†Œ (ì¹´ìš´í„° 1ê°œ)

**ë‹¨ì :**
- **Boundary ë¬¸ì œ**: ìœˆë„ìš° ê²½ê³„ì—ì„œ 2ë°°ì˜ ìš”ì²­ í—ˆìš© ê°€ëŠ¥
  - 00:59ì— 100ê°œ + 01:00ì— 100ê°œ = 1ë¶„ ë™ì•ˆ 200ê°œ

```
          Window 1          |          Window 2
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                      100ê°œ â”‚ 100ê°œ
                     â†‘      â”‚      â†‘
                   00:59   01:00  01:01

    ì‹¤ì œë¡œ 00:59~01:01 (2ë¶„) ë™ì•ˆ 200ê°œ ìš”ì²­ í†µê³¼!
```

---

### 1.2 Sliding Window Log (ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ë¡œê·¸)

```
í˜„ì¬ ì‹œê°„: 01:30
ìœˆë„ìš° í¬ê¸°: 1ì‹œê°„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
    â”‚                                              â”‚
  00:30                                          01:30
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ ë²”ìœ„ì˜ ìš”ì²­ë§Œ ì¹´ìš´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì €ì¥ëœ ë¡œê·¸:
[00:45, 00:50, 01:00, 01:15, 01:20, 01:25]
         â†“ ìœˆë„ìš° ë°– â†’ ì œê±°
[01:00, 01:15, 01:20, 01:25] â†’ Count: 4
```

**ì¥ì :**
- ì •í™•í•œ Rate Limiting (Boundary ë¬¸ì œ ì—†ìŒ)

**ë‹¨ì :**
- **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë†’ìŒ**: ëª¨ë“  ìš”ì²­ íƒ€ì„ìŠ¤íƒ¬í”„ ì €ì¥ í•„ìš”
- ì‹œê°„ ë³µì¡ë„: O(N) where N = ìœˆë„ìš° ë‚´ ìš”ì²­ ìˆ˜

---

### 1.3 Sliding Window Counter (ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ì¹´ìš´í„°)

```
í˜„ì¬ ì‹œê°„: 01:15 (í˜„ì¬ ìœˆë„ìš°ì˜ 25% ì§€ì )
ì´ì „ ìœˆë„ìš°: 80ê°œ ìš”ì²­
í˜„ì¬ ìœˆë„ìš°: 20ê°œ ìš”ì²­

ê°€ì¤‘ì¹˜ ê³„ì‚°:
ì´ì „ ìœˆë„ìš° ê¸°ì—¬ = 80 Ã— 0.75 = 60 (75% ë‚¨ìŒ)
í˜„ì¬ ìœˆë„ìš° ê¸°ì—¬ = 20 Ã— 1.00 = 20 (100%)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì˜ˆìƒ ì¹´ìš´íŠ¸     = 80ê°œ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ì´ì „ ìœˆë„ìš°    â”‚   í˜„ì¬ ìœˆë„ìš°    â”‚
â”‚   00:00-01:00   â”‚   01:00-02:00   â”‚
â”‚                 â”‚                 â”‚
â”‚   80ê°œ Ã— 75%    â”‚   20ê°œ Ã— 100%   â”‚
â”‚   = 60ê°œ        â”‚   = 20ê°œ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–²
               01:15 (í˜„ì¬)
```

**ì¥ì :**
- Fixed Windowë³´ë‹¤ ì •í™• (Boundary ë¬¸ì œ ì™„í™”)
- ë©”ëª¨ë¦¬ íš¨ìœ¨ì  (ì¹´ìš´í„° 2ê°œë§Œ í•„ìš”)

**ë‹¨ì :**
- ì™„ë²½íˆ ì •í™•í•˜ì§€ëŠ” ì•ŠìŒ (ê·¼ì‚¬ì¹˜)

---

### 1.4 Token Bucket (í† í° ë²„í‚·) â­ FluxGate ì±„íƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Token Bucket                         â”‚
â”‚                                                         â”‚
â”‚   ìš©ëŸ‰ (Capacity): 100 í† í°                              â”‚
â”‚   ë¦¬í•„ ì†ë„: 10 í† í°/ì´ˆ                                   â”‚
â”‚                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ â—‹ â—‹ â—‹ â—‹ â—‹ â—‹ â—‹ â—‹ â—‹ â—‹  (í˜„ì¬ í† í°: 70ê°œ)        â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â”‚   ìš”ì²­ ë„ì°© â†’ í† í° 1ê°œ ì†Œë¹„                              â”‚
â”‚   - í† í° > 0: í—ˆìš© âœ“                                    â”‚
â”‚   - í† í° = 0: ê±°ë¶€ âœ— (429 Too Many Requests)           â”‚
â”‚                                                         â”‚
â”‚   ì‹œê°„ì´ ì§€ë‚˜ë©´ í† í° ìë™ ë¦¬í•„ (ìµœëŒ€ ìš©ëŸ‰ê¹Œì§€)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì¥ì :**
- **ë²„ìŠ¤íŠ¸ í—ˆìš©**: ì§§ì€ ì‹œê°„ì— ìš©ëŸ‰ë§Œí¼ ìš”ì²­ ê°€ëŠ¥
- **í‰ê·  ì†ë„ ì œí•œ**: ì¥ê¸°ì ìœ¼ë¡œ ë¦¬í•„ ì†ë„ë¡œ ì œí•œ
- **ìœ ì—°í•œ ì„¤ì •**: ìš©ëŸ‰ê³¼ ë¦¬í•„ ì†ë„ ë…ë¦½ì  ì„¤ì •
- **ë©”ëª¨ë¦¬ íš¨ìœ¨ì **: í† í° ìˆ˜ì™€ ë§ˆì§€ë§‰ ë¦¬í•„ ì‹œê°„ë§Œ ì €ì¥

**ë‹¨ì :**
- Fixed Windowë³´ë‹¤ êµ¬í˜„ ë³µì¡

---

### 1.5 Leaky Bucket (ëˆ„ìˆ˜ ë²„í‚·)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Leaky Bucket                         â”‚
â”‚                                                         â”‚
â”‚        ìš”ì²­ ë“¤ì–´ì˜´                                       â”‚
â”‚            â†“                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ â–  â–  â–  â–  â–  â–  â–  â–  â–  â–   (íì— ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­)     â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚                                            â”‚
â”‚            â†“ ì¼ì •í•œ ì†ë„ë¡œ ì²˜ë¦¬ (leak)                   â”‚
â”‚         â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚         ì²˜ë¦¬ë¨                                          â”‚
â”‚                                                         â”‚
â”‚   íê°€ ê°€ë“ ì°¨ë©´ â†’ ìƒˆ ìš”ì²­ ê±°ë¶€                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì¥ì :**
- ì¶œë ¥ ì†ë„ê°€ ì¼ì • (íŠ¸ë˜í”½ ì„±í˜•)
- ë²„ìŠ¤íŠ¸ í¡ìˆ˜

**ë‹¨ì :**
- ë²„ìŠ¤íŠ¸ ìš”ì²­ ì‹œ ì§€ì—° ë°œìƒ (í ëŒ€ê¸°)
- Token Bucketë³´ë‹¤ ëœ ìœ ì—°

---

#### ğŸ“‹ ìƒí™©ë³„ ì•Œê³ ë¦¬ì¦˜ ì„ íƒ ê°€ì´ë“œ

| ìƒí™© | ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ | ì´ìœ  |
|------|-------------|------|
| API ê³¼ê¸ˆ (ì •í™•í•œ ì¹´ìš´íŠ¸ í•„ìš”) | Sliding Window Log | ì •í™•ë„ê°€ ê°€ì¥ ì¤‘ìš” |
| ì¼ë°˜ì ì¸ API Rate Limit | Token Bucket | ë²„ìŠ¤íŠ¸ í—ˆìš© + ê°„ë‹¨í•¨ |
| DB ë³´í˜¸, íŠ¸ë˜í”½ í‰íƒ„í™” | Leaky Bucket | ì¼ì •í•œ ì²˜ë¦¬ëŸ‰ ë³´ì¥ |
| ë‹¨ìˆœí•œ êµ¬í˜„, ë¦¬ì†ŒìŠ¤ ì œí•œ | Fixed Window | êµ¬í˜„ ì‰¬ì›€ |

---

#### ğŸ¯ Token Bucket vs Leaky Bucket ì‹¤ì œ ë™ì‘ ë¹„êµ

```
ì‹œë‚˜ë¦¬ì˜¤: ê²°ì œ API (10 req/sec ì œí•œ)
ì‚¬ìš©ìê°€ 0ì´ˆì— 10ê°œ ìš”ì²­ì„ ë™ì‹œì— ë³´ëƒ„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Token Bucket                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0.0ì´ˆ: 10ê°œ ìš”ì²­ â†’ 10ê°œ ëª¨ë‘ ì¦‰ì‹œ í†µê³¼ âœ…                      â”‚
â”‚ 0.1ì´ˆ: 1ê°œ ìš”ì²­ â†’ í† í° ì—†ìŒ, ê±°ë¶€ âŒ                          â”‚
â”‚ 1.0ì´ˆ: í† í° ë¦¬í•„ â†’ ë‹¤ì‹œ 10ê°œ ê°€ëŠ¥                             â”‚
â”‚                                                             â”‚
â”‚ ê²°ê³¼: ì„œë²„ê°€ ìˆœê°„ì ìœ¼ë¡œ 10ê°œ ë™ì‹œ ì²˜ë¦¬í•´ì•¼ í•¨ ğŸ’¥               â”‚
â”‚ ì¥ì : ì‚¬ìš©ì ì‘ë‹µ ë¹ ë¦„                                        â”‚
â”‚ ë‹¨ì : ì„œë²„ ë¶€í•˜ ìŠ¤íŒŒì´í¬ ë°œìƒ ê°€ëŠ¥                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Leaky Bucket                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0.0ì´ˆ: 10ê°œ ìš”ì²­ â†’ 1ê°œ í†µê³¼, 9ê°œ í ëŒ€ê¸°                      â”‚
â”‚ 0.1ì´ˆ: íì—ì„œ 1ê°œ ì²˜ë¦¬ â†’ 8ê°œ ëŒ€ê¸°                             â”‚
â”‚ 0.2ì´ˆ: íì—ì„œ 1ê°œ ì²˜ë¦¬ â†’ 7ê°œ ëŒ€ê¸°                             â”‚
â”‚ ...                                                         â”‚
â”‚ 0.9ì´ˆ: íì—ì„œ 1ê°œ ì²˜ë¦¬ â†’ 0ê°œ ëŒ€ê¸°                             â”‚
â”‚                                                             â”‚
â”‚ ê²°ê³¼: ì„œë²„ëŠ” í•­ìƒ 1ê°œì”©ë§Œ ì²˜ë¦¬ âœ…                              â”‚
â”‚ ì¥ì : ì„œë²„ ë¶€í•˜ ì¼ì •                                          â”‚
â”‚ ë‹¨ì : ì‚¬ìš©ì ì‘ë‹µ ì§€ì—° (ìµœëŒ€ 0.9ì´ˆ ëŒ€ê¸°)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### ğŸ¯ FluxGateê°€ Token Bucketì„ ì„ íƒí•œ ì´ìœ 

```
1. API Gateway ìš©ë„
   â†’ ë²„ìŠ¤íŠ¸ í—ˆìš©ì´ ì‚¬ìš©ì ê²½í—˜ì— ì¢‹ìŒ
   â†’ ì¦‰ê°ì ì¸ ì‘ë‹µì´ ì¤‘ìš”

2. ì„±ëŠ¥
   â†’ O(1) ì‹œê°„ë³µì¡ë„
   â†’ Redis Lua ìŠ¤í¬ë¦½íŠ¸ë¡œ ì›ìì  ì²˜ë¦¬ ê°€ëŠ¥

3. ìœ ì—°ì„±
   â†’ Multi-Band ì§€ì› (10/ì´ˆ + 100/ë¶„ + 1000/ì‹œê°„)
   â†’ ë‹¤ì–‘í•œ Rate Limit ì •ì±… ì ìš© ê°€ëŠ¥
```

> **ì°¸ê³ :** DB ë³´í˜¸ë‚˜ íŠ¸ë˜í”½ í‰íƒ„í™”ê°€ ëª©ì ì´ë¼ë©´ Leaky Bucketì´ ë” ì í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
// ë‹¤ì¤‘ ëŒ€ì—­í­ ì˜ˆì‹œ
RateLimitRule.builder()
    .addBand(100, Duration.ofMinutes(1))   // ë¶„ë‹¹ 100ê°œ
    .addBand(1000, Duration.ofHours(1))    // ì‹œê°„ë‹¹ 1000ê°œ
    .build();
```

---

## 2. RateLimiter ì¸í„°í˜ì´ìŠ¤

```
ğŸ“ fluxgate-core/src/main/java/org/fluxgate/core/ratelimiter/
â””â”€â”€ RateLimiter.java
```

```java
// RateLimiter.java
public interface RateLimiter {

  /**
   * í† í° ì†Œë¹„ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.
   *
   * @param context ìš”ì²­ ì»¨í…ìŠ¤íŠ¸
   * @param ruleSet ì ìš©í•  ê·œì¹™ ì„¸íŠ¸
   * @param permits ì†Œë¹„í•  í† í° ìˆ˜
   * @return Rate Limit ê²°ê³¼
   */
  RateLimitResult tryConsume(RequestContext context, RateLimitRuleSet ruleSet, long permits);

  // ê¸°ë³¸ 1í† í° ì†Œë¹„
  default RateLimitResult tryConsume(RequestContext context, RateLimitRuleSet ruleSet) {
    return tryConsume(context, ruleSet, 1);
  }
}
```

---

## 3. Bucket4jRateLimiter

Bucket4jë¥¼ ì‚¬ìš©í•˜ëŠ” Rate Limiter êµ¬í˜„ì…ë‹ˆë‹¤.

```
ğŸ“ fluxgate-core/src/main/java/org/fluxgate/core/ratelimiter/impl/bucket4j/
â””â”€â”€ Bucket4jRateLimiter.java
```

```java
// Bucket4jRateLimiter.java
public class Bucket4jRateLimiter implements RateLimiter {

  private final TokenBucketStore bucketStore;  // â† TBS
  private final KeyResolver keyResolver;

  @Override
  public RateLimitResult tryConsume(
      RequestContext context,
      RateLimitRuleSet ruleSet,
      long permits) {

    // ë§¤ì¹­ëœ ê·œì¹™ ì°¾ê¸°
    RateLimitRule rule = findMatchingRule(ruleSet, context);
    if (rule == null) {
      return RateLimitResult.allowed(permits);
    }

    // í‚¤ ìƒì„±
    RateLimitKey key = keyResolver.resolve(rule, context);

    // ğŸ“Œ TokenBucketStoreë¡œ í† í° ì†Œë¹„ â† TBSë¡œ í–¥í•˜ëŠ” í™”ì‚´í‘œ
    BucketState state = bucketStore.consume(
        key.toKeyString(),
        rule.getBands(),
        permits
    );

    if (state.isAllowed()) {
      return RateLimitResult.builder()
          .allowed(true)
          .remainingTokens(state.getRemainingTokens())
          .matchedRule(rule)
          .build();
    } else {
      return RateLimitResult.builder()
          .allowed(false)
          .remainingTokens(state.getRemainingTokens())
          .nanosToWaitForRefill(state.getNanosToWaitForRefill())
          .matchedRule(rule)
          .build();
    }
  }
}
```

---

## 4. Redis Lua ìŠ¤í¬ë¦½íŠ¸ (ë¶„ì‚° í™˜ê²½)

ë¶„ì‚° í™˜ê²½ì—ì„œ Rate Limitingì„ êµ¬í˜„í•  ë•Œ ê°€ì¥ í° ë¬¸ì œëŠ” **Race Condition**ì…ë‹ˆë‹¤. FluxGateëŠ” Redis Lua ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•´ ì´ ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.

### 4.1 ì™œ Lua ìŠ¤í¬ë¦½íŠ¸ì¸ê°€?

```
ë¬¸ì œ: Race Condition (ê²½ìŸ ìƒíƒœ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ì„œë²„ A                     ì„œë²„ B
   â”‚                          â”‚
   â”œâ”€ GET tokens â†’ 5          â”‚
   â”‚                          â”œâ”€ GET tokens â†’ 5
   â”œâ”€ tokens - 1 = 4          â”‚
   â”‚                          â”œâ”€ tokens - 1 = 4
   â”œâ”€ SET tokens 4            â”‚
   â”‚                          â”œâ”€ SET tokens 4  â† ë¬¸ì œ!
   â–¼                          â–¼

ê²°ê³¼: 2ë²ˆ ì†Œë¹„í–ˆëŠ”ë° 1ê°œë§Œ ê°ì†Œ (ë²„ê·¸!)
```

```
í•´ê²°: Lua ìŠ¤í¬ë¦½íŠ¸ = ì›ìì (Atomic) ì‹¤í–‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ì„œë²„ A                     Redis (ì‹±ê¸€ ìŠ¤ë ˆë“œ)
   â”‚                          â”‚
   â”œâ”€ EVALSHA lua_script â”€â”€â”€â”€â–¶â”‚ ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ ì‹¤í–‰
   â”‚                          â”‚ (ì¤‘ê°„ì— ëŠê¸°ì§€ ì•ŠìŒ)
   â”‚â—€â”€â”€â”€â”€ ê²°ê³¼ ë°˜í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                          â”‚
ì„œë²„ B                         â”‚
   â”œâ”€ EVALSHA lua_script â”€â”€â”€â”€â–¶â”‚ ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
   â”‚                          â”‚
```

RedisëŠ” ì‹±ê¸€ ìŠ¤ë ˆë“œë¡œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì—, Lua ìŠ¤í¬ë¦½íŠ¸ëŠ” **ì¤‘ê°„ì— ë‹¤ë¥¸ ëª…ë ¹ì´ ë¼ì–´ë“¤ ìˆ˜ ì—†ì´** ì™„ì „íˆ ì‹¤í–‰ë©ë‹ˆë‹¤.

---

### 4.2 ì•„í‚¤í…ì²˜ íë¦„

```mermaid
graph TD
    A[Java: RedisTokenBucketStore] -->|1. EVALSHA sha, key, args| B[Redis Server]
    B -->|2. ìºì‹œëœ Lua ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰| C[token_bucket_consume.lua]
    C -->|3. HMGET/HMSET ì‹¤í–‰| D[(Redis Hash)]
    C -->|4. ê²°ê³¼ ë°˜í™˜| A
```

---

### 4.3 ì½”ë“œ êµ¬ì¡°

```
ğŸ“ fluxgate-redis-ratelimiter/src/main/
â”œâ”€â”€ java/org/fluxgate/redis/
â”‚   â”œâ”€â”€ script/
â”‚   â”‚   â”œâ”€â”€ LuaScripts.java       # SHA í•´ì‹œ ë° ìŠ¤í¬ë¦½íŠ¸ ìºì‹œ
â”‚   â”‚   â””â”€â”€ LuaScriptLoader.java  # ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ë° Redis ì—…ë¡œë“œ
â”‚   â””â”€â”€ store/
â”‚       â””â”€â”€ RedisTokenBucketStore.java  # Lua ìŠ¤í¬ë¦½íŠ¸ í˜¸ì¶œ
â””â”€â”€ resources/lua/
    â””â”€â”€ token_bucket_consume.lua  # ì‹¤ì œ Lua ìŠ¤í¬ë¦½íŠ¸
```

---

### 4.4 ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ì•± ì‹œì‘ ì‹œ (LuaScriptLoader.loadScripts)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   .lua íŒŒì¼ ì½ê¸° â†’ Redisì— ì—…ë¡œë“œ â†’ SHA í•´ì‹œ ë°›ê¸°                  â”‚
â”‚                                                                 â”‚
â”‚   String script = loadScriptFromClasspath("/lua/...")           â”‚
â”‚       â†“                                                         â”‚
â”‚   String sha = connectionProvider.scriptLoad(script)            â”‚
â”‚       â†“                                                         â”‚
â”‚   LuaScripts.setTokenBucketConsumeSha(sha)  â† ìºì‹œ ì €ì¥          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ìš”ì²­ ì‹œë§ˆë‹¤ (RedisTokenBucketStore.tryConsume)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   tryConsume("bucket:user:123", band, 1)                        â”‚
â”‚       â†“                                                         â”‚
â”‚   String sha = LuaScripts.getTokenBucketConsumeSha()            â”‚
â”‚       â†“                                                         â”‚
â”‚   connectionProvider.evalsha(sha, keys, args)  â† ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰   â”‚
â”‚       â†“                                                         â”‚
â”‚   ê²°ê³¼: [consumed, remaining, wait_nanos, reset_time]           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4.5 EVAL vs EVALSHA

```
EVAL (ëŠë¦¼)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client: EVAL "ê¸´ ìŠ¤í¬ë¦½íŠ¸ ì „ì²´..." 1 key arg1 arg2
        â†‘ ë§¤ë²ˆ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡ (ë„¤íŠ¸ì›Œí¬ ë‚­ë¹„)

EVALSHA (ë¹ ë¦„) â† FluxGateê°€ ì‚¬ìš©í•˜ëŠ” ë°©ì‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1íšŒì°¨: SCRIPT LOAD "ê¸´ ìŠ¤í¬ë¦½íŠ¸..." â†’ SHA: "abc123..."
ì´í›„:  EVALSHA "abc123..." 1 key arg1 arg2
       â†‘ 40ë°”ì´íŠ¸ SHAë§Œ ì „ì†¡
```

---

### 4.6 Lua ìŠ¤í¬ë¦½íŠ¸ ì™„ì „ ë¶„ì„ (í•œ ì¤„ì”© ì„¤ëª…)

```
ğŸ“ fluxgate-redis-ratelimiter/src/main/resources/lua/
â””â”€â”€ token_bucket_consume.lua
```

ì´ ì„¹ì…˜ì—ì„œëŠ” Lua ìŠ¤í¬ë¦½íŠ¸ì˜ **ëª¨ë“  ì¤„**ì„ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.

**ëª©ì°¨:**
- [ğŸ“Œ ì‹¤ì œ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ì´í•´í•˜ê¸°](#-ì‹¤ì œ-ì‹œë‚˜ë¦¬ì˜¤ë¡œ-ì´í•´í•˜ê¸°)
- [ğŸ“– ë³€ìˆ˜ ì •ì˜ ì‚¬ì „](#-ë³€ìˆ˜-ì •ì˜-ì‚¬ì „) â† **ë¨¼ì € ì½ì–´ì£¼ì„¸ìš”!**
- [STEP 1~10: ìƒì„¸ ì½”ë“œ ë¶„ì„](#step-1-ì…ë ¥-íŒŒë¼ë¯¸í„°-ë°›ê¸°)

---

#### ğŸ“Œ ì‹¤ì œ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ì´í•´í•˜ê¸°

```
ìƒí™© ì„¤ì •:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ API: /api/users (ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ)
â€¢ ì œí•œ: ë¶„ë‹¹ 100ê°œ ìš”ì²­
â€¢ í˜„ì¬ ì‚¬ìš©ì: IP 192.168.1.100
â€¢ í˜„ì¬ ìƒíƒœ: ì´ë¯¸ 70ë²ˆ ìš”ì²­í•¨ (30ê°œ ë‚¨ìŒ)
â€¢ ìš”ì²­: 1ê°œ í† í° ì†Œë¹„í•˜ê³  ì‹¶ìŒ
```

---

#### ğŸ“– ë³€ìˆ˜ ì •ì˜ ì‚¬ì „

ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©ë˜ëŠ” ëª¨ë“  ë³€ìˆ˜ë“¤ì„ ë¯¸ë¦¬ ì •ë¦¬í•©ë‹ˆë‹¤:

##### ì…ë ¥ ë³€ìˆ˜ (Javaì—ì„œ ì „ë‹¬)

| ë³€ìˆ˜ëª… | íƒ€ì… | ì„¤ëª… | ì˜ˆì‹œ ê°’ |
|--------|------|------|---------|
| `bucket_key` | string | ë²„í‚·ì„ ì‹ë³„í•˜ëŠ” Redis í‚¤ | `"fluxgate:api-limits:per-ip:192.168.1.100:per-minute"` |
| `capacity` | number | ë²„í‚·ì˜ ìµœëŒ€ í† í° ìš©ëŸ‰ | `100` |
| `window_nanos` | number | ìœˆë„ìš° í¬ê¸° (ë‚˜ë…¸ì´ˆ) | `60000000000` (60ì´ˆ) |
| `permits` | number | ì†Œë¹„í•˜ë ¤ëŠ” í† í° ìˆ˜ | `1` |

##### ì‹œê°„ ê´€ë ¨ ë³€ìˆ˜

| ë³€ìˆ˜ëª… | íƒ€ì… | ì„¤ëª… | ì˜ˆì‹œ ê°’ |
|--------|------|------|---------|
| `time_info` | table | Redis TIME ëª…ë ¹ ê²°ê³¼ [ì´ˆ, ë§ˆì´í¬ë¡œì´ˆ] | `{"1703001234", "567890"}` |
| `current_time_micros` | number | í˜„ì¬ ì‹œê°„ (ë§ˆì´í¬ë¡œì´ˆ) | `1703001234567890` |
| `current_time_nanos` | number | í˜„ì¬ ì‹œê°„ (ë‚˜ë…¸ì´ˆ) | `1703001234567890000` |
| `last_refill_nanos` | number | **ë§ˆì§€ë§‰ìœ¼ë¡œ í† í°ì„ ë¦¬í•„í•œ ì‹œê°„** (ë‚˜ë…¸ì´ˆ) | `1703001204567890000` |
| `elapsed_nanos` | number | **ë§ˆì§€ë§‰ ë¦¬í•„ ì´í›„ ê²½ê³¼í•œ ì‹œê°„** (ë‚˜ë…¸ì´ˆ) | `30000000000` (30ì´ˆ) |

##### í† í° ê´€ë ¨ ë³€ìˆ˜

| ë³€ìˆ˜ëª… | íƒ€ì… | ì„¤ëª… | ì˜ˆì‹œ ê°’ |
|--------|------|------|---------|
| `bucket_data` | table | Redis Hashì—ì„œ ì½ì–´ì˜¨ ë°ì´í„° | `{"30", "1703001204567890000"}` |
| `current_tokens` | number | **í˜„ì¬ ë²„í‚·ì— ë‚¨ì•„ìˆëŠ” í† í° ìˆ˜** | `30` |
| `tokens_to_add` | number | **ë¦¬í•„í•  í† í° ìˆ˜** (ê²½ê³¼ ì‹œê°„ ê¸°ë°˜ ê³„ì‚°) | `50` |
| `new_tokens` | number | **ë¦¬í•„ í›„ í† í° ìˆ˜** (ìš©ëŸ‰ ì´ˆê³¼ ë°©ì§€) | `80` |
| `tokens_needed` | number | ë¶€ì¡±í•œ í† í° ìˆ˜ (ê±°ë¶€ ì‹œ) | `1` |
| `tokens_until_full` | number | ê°€ë“ ì°° ë•Œê¹Œì§€ í•„ìš”í•œ í† í° ìˆ˜ | `20` |

##### ì¶œë ¥/ê²°ê³¼ ë³€ìˆ˜

| ë³€ìˆ˜ëª… | íƒ€ì… | ì„¤ëª… | ì˜ˆì‹œ ê°’ |
|--------|------|------|---------|
| `nanos_to_wait` | number | **ë‹¤ìŒ í† í°ê¹Œì§€ ëŒ€ê¸°í•´ì•¼ í•  ì‹œê°„** (ê±°ë¶€ ì‹œ) | `600000000` (0.6ì´ˆ) |
| `nanos_until_full` | number | ë²„í‚·ì´ ê°€ë“ ì°° ë•Œê¹Œì§€ ê±¸ë¦¬ëŠ” ì‹œê°„ | `12000000000` (12ì´ˆ) |
| `reset_time_millis` | number | ë²„í‚· ë¦¬ì…‹ ì˜ˆìƒ ì‹œê°„ (Unix timestamp ms) | `1703001306567` |

##### TTL ê´€ë ¨ ë³€ìˆ˜

| ë³€ìˆ˜ëª… | íƒ€ì… | ì„¤ëª… | ì˜ˆì‹œ ê°’ |
|--------|------|------|---------|
| `desired_ttl_seconds` | number | ì›í•˜ëŠ” TTL (ìœˆë„ìš° Ã— 1.1) | `66` |
| `actual_ttl_seconds` | number | ì‹¤ì œ TTL (ìµœëŒ€ 24ì‹œê°„ ì œí•œ) | `66` |

---

##### ğŸ”‘ í•µì‹¬ ë³€ìˆ˜ 3ê°œ ê¹Šê²Œ ì´í•´í•˜ê¸°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. last_refill_nanos (ë§ˆì§€ë§‰ ë¦¬í•„ ì‹œê°„)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   "ë§ˆì§€ë§‰ìœ¼ë¡œ í† í°ì´ ì¶”ê°€ëœ ì‹œì "                                         â”‚
â”‚                                                                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ì‹œê°„  â”‚
â”‚        â”‚                              â”‚                                 â”‚
â”‚   last_refill_nanos              current_time_nanos                     â”‚
â”‚   (ê³¼ê±°)                          (í˜„ì¬)                                â”‚
â”‚                                                                         â”‚
â”‚   ì´ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ "ì–¼ë§ˆë‚˜ ì‹œê°„ì´ ì§€ë‚¬ëŠ”ì§€" ê³„ì‚°í•´ì„œ                       â”‚
â”‚   ê·¸ë§Œí¼ í† í°ì„ ë¦¬í•„í•©ë‹ˆë‹¤.                                              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. elapsed_nanos (ê²½ê³¼ ì‹œê°„)                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   elapsed_nanos = current_time_nanos - last_refill_nanos                â”‚
â”‚                                                                         â”‚
â”‚   ì˜ˆì‹œ: ë§ˆì§€ë§‰ ë¦¬í•„ì´ 30ì´ˆ ì „ì´ì—ˆë‹¤ë©´                                     â”‚
â”‚   elapsed_nanos = 30,000,000,000 ë‚˜ë…¸ì´ˆ (30ì´ˆ)                          â”‚
â”‚                                                                         â”‚
â”‚   ì´ ê²½ê³¼ ì‹œê°„ì— ë¹„ë¡€í•´ì„œ í† í°ì´ ë¦¬í•„ë©ë‹ˆë‹¤:                              â”‚
â”‚   - 30ì´ˆ ê²½ê³¼, ìœˆë„ìš° 60ì´ˆ, ìš©ëŸ‰ 100 â†’ 50ê°œ ë¦¬í•„                         â”‚
â”‚   - 60ì´ˆ ê²½ê³¼, ìœˆë„ìš° 60ì´ˆ, ìš©ëŸ‰ 100 â†’ 100ê°œ ë¦¬í•„ (ê°€ë“!)                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. nanos_to_wait (ëŒ€ê¸° ì‹œê°„) - ê±°ë¶€ëœ ê²½ìš°ì—ë§Œ ì‚¬ìš©                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   "ë‹¤ìŒ í† í°ì´ ìƒê¸¸ ë•Œê¹Œì§€ ì–¼ë§ˆë‚˜ ê¸°ë‹¤ë ¤ì•¼ í•˜ëŠ”ê°€?"                        â”‚
â”‚                                                                         â”‚
â”‚   ê³„ì‚°: (í•„ìš”í•œ í† í° ìˆ˜ Ã— ìœˆë„ìš°) / ìš©ëŸ‰                                  â”‚
â”‚                                                                         â”‚
â”‚   ì˜ˆì‹œ: 1ê°œ í† í° í•„ìš”, ìœˆë„ìš° 60ì´ˆ, ìš©ëŸ‰ 100                              â”‚
â”‚   nanos_to_wait = (1 Ã— 60,000,000,000) / 100                            â”‚
â”‚                 = 600,000,000 ë‚˜ë…¸ì´ˆ                                    â”‚
â”‚                 = 0.6ì´ˆ                                                 â”‚
â”‚                                                                         â”‚
â”‚   â†’ HTTP ì‘ë‹µì—ì„œ Retry-After: 1 ë¡œ ë³€í™˜                                 â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### STEP 1: ì…ë ¥ íŒŒë¼ë¯¸í„° ë°›ê¸°

```lua
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- STEP 1: ì…ë ¥ íŒŒë¼ë¯¸í„° íŒŒì‹±
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- KEYS[1] = Redis í‚¤ (ì–´ë–¤ ë²„í‚·ì¸ì§€ ì‹ë³„)
local bucket_key = KEYS[1]
-- ì˜ˆì‹œ: "fluxgate:api-limits:per-ip:192.168.1.100:per-minute"
--        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
--        ì´ í‚¤ë¡œ Redis Hashì— í† í° ì •ë³´ ì €ì¥

-- ARGV[1] = ë²„í‚· ìš©ëŸ‰ (ìµœëŒ€ í† í° ìˆ˜)
local capacity = tonumber(ARGV[1])
-- ì˜ˆì‹œ: 100 (ë¶„ë‹¹ 100ê°œ ìš”ì²­ í—ˆìš©)
--       â””â”€â”€ tonumber(): ë¬¸ìì—´ "100" â†’ ìˆ«ì 100ìœ¼ë¡œ ë³€í™˜

-- ARGV[2] = ìœˆë„ìš° í¬ê¸° (ë‚˜ë…¸ì´ˆ ë‹¨ìœ„)
local window_nanos = tonumber(ARGV[2])
-- ì˜ˆì‹œ: 60000000000 (60ì´ˆ = 1ë¶„)
--       â”‚
--       â””â”€â”€ ê³„ì‚°: 60ì´ˆ Ã— 1,000,000,000 ë‚˜ë…¸ì´ˆ/ì´ˆ = 60,000,000,000
--
-- Q: ì™œ ë‚˜ë…¸ì´ˆ?
-- A: ë°€ë¦¬ì´ˆ(ms)ë³´ë‹¤ ì •ë°€í•´ì„œ ì´ˆë‹¹ ìˆ˜ë§Œ ê°œ ìš”ì²­ë„ ì •í™•íˆ ê³„ì‚° ê°€ëŠ¥

-- ARGV[3] = ì†Œë¹„í•  í† í° ìˆ˜
local permits = tonumber(ARGV[3])
-- ì˜ˆì‹œ: 1 (ì¼ë°˜ì ìœ¼ë¡œ ìš”ì²­ë‹¹ 1ê°œ)
--       ë‹¨, ë¬´ê±°ìš´ APIëŠ” permits=10ì²˜ëŸ¼ ë” ë§ì´ ì†Œë¹„ ê°€ëŠ¥
```

**ì‹œê°í™”:**
```
Javaì—ì„œ í˜¸ì¶œ:
connectionProvider.evalsha(sha,
    new String[]{"fluxgate:api-limits:per-ip:192.168.1.100:per-minute"},  // KEYS
    new String[]{"100", "60000000000", "1"}  // ARGV
);

Luaì—ì„œ ë°›ìŒ:
KEYS[1] = "fluxgate:api-limits:per-ip:192.168.1.100:per-minute"
ARGV[1] = "100"           â†’ capacity = 100
ARGV[2] = "60000000000"   â†’ window_nanos = 60,000,000,000
ARGV[3] = "1"             â†’ permits = 1
```

---

#### STEP 2: ì…ë ¥ ê²€ì¦

```lua
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- STEP 2: ì…ë ¥ê°’ ê²€ì¦ (ì˜ëª»ëœ ê°’ ë°©ì§€)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if capacity <= 0 or window_nanos <= 0 or permits <= 0 then
    return redis.error_reply("Invalid arguments: capacity, window, and permits must be positive")
end

-- ì˜ˆì‹œ:
-- capacity = -1   â†’ ì—ëŸ¬! (ìš©ëŸ‰ì´ ìŒìˆ˜ì¼ ìˆ˜ ì—†ìŒ)
-- window_nanos = 0 â†’ ì—ëŸ¬! (ìœˆë„ìš°ê°€ 0ì´ë©´ ë‚˜ëˆ„ê¸° ì—ëŸ¬)
-- permits = 0     â†’ ì—ëŸ¬! (0ê°œ ì†Œë¹„ëŠ” ì˜ë¯¸ ì—†ìŒ)
```

---

#### STEP 3: í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (Redis ì„œë²„ ì‹œê°„)

```lua
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- STEP 3: Redis ì„œë²„ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--
-- Q: ì™œ Javaì˜ System.nanoTime()ì„ ì•ˆ ì“°ê³  Redis TIMEì„ ì“°ë‚˜ìš”?
-- A: í´ëŸ­ ë“œë¦¬í”„íŠ¸ ë¬¸ì œ!
--
--    ì„œë²„ A ì‹œê³„: 10:00:00.000
--    ì„œë²„ B ì‹œê³„: 10:00:00.500  â† 0.5ì´ˆ ì°¨ì´!
--    ì„œë²„ C ì‹œê³„: 09:59:59.800  â† 0.2ì´ˆ ëŠë¦¼!
--
--    â†’ ê° ì„œë²„ê°€ ë‹¤ë¥¸ ì‹œê°„ìœ¼ë¡œ ê³„ì‚°í•˜ë©´ Rate Limitì´ ì •í™•í•˜ì§€ ì•ŠìŒ
--    â†’ Redis ì„œë²„ ì‹œê°„ì„ ì“°ë©´ ëª¨ë“  ì„œë²„ê°€ ë™ì¼í•œ ì‹œê°„ ì‚¬ìš©!

local time_info = redis.call('TIME')
-- redis.call('TIME') ê²°ê³¼:
-- time_info[1] = "1703001234"   â† Unix ì´ˆ (epoch seconds)
-- time_info[2] = "567890"       â† ë§ˆì´í¬ë¡œì´ˆ (0~999999)

-- ë§ˆì´í¬ë¡œì´ˆë¡œ ë³€í™˜
local current_time_micros = tonumber(time_info[1]) * 1000000 + tonumber(time_info[2])
-- ê³„ì‚°: 1703001234 Ã— 1,000,000 + 567890 = 1,703,001,234,567,890 ë§ˆì´í¬ë¡œì´ˆ

-- ë‚˜ë…¸ì´ˆë¡œ ë³€í™˜ (ë” ì •ë°€í•˜ê²Œ)
local current_time_nanos = current_time_micros * 1000
-- ê³„ì‚°: 1,703,001,234,567,890 Ã— 1,000 = 1,703,001,234,567,890,000 ë‚˜ë…¸ì´ˆ
```

**ì‹œê°„ ë‹¨ìœ„ ë¹„êµ:**
```
1ì´ˆ      = 1,000 ë°€ë¦¬ì´ˆ (ms)
1ë°€ë¦¬ì´ˆ  = 1,000 ë§ˆì´í¬ë¡œì´ˆ (Î¼s)
1ë§ˆì´í¬ë¡œì´ˆ = 1,000 ë‚˜ë…¸ì´ˆ (ns)

ë”°ë¼ì„œ:
1ì´ˆ = 1,000,000,000 ë‚˜ë…¸ì´ˆ (10ì–µ)

ì˜ˆì‹œ ë³€í™˜:
Unix timestamp 1703001234.567890
= 1,703,001,234ì´ˆ + 567,890ë§ˆì´í¬ë¡œì´ˆ
= 1,703,001,234,567,890ë§ˆì´í¬ë¡œì´ˆ
= 1,703,001,234,567,890,000ë‚˜ë…¸ì´ˆ
```

---

#### STEP 4: í˜„ì¬ ë²„í‚· ìƒíƒœ ì½ê¸°

```lua
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- STEP 4: Redisì—ì„œ í˜„ì¬ ë²„í‚· ìƒíƒœ ì½ê¸°
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local bucket_data = redis.call('HMGET', bucket_key, 'tokens', 'last_refill_nanos')
-- HMGET = Hash Multi GET (Hashì—ì„œ ì—¬ëŸ¬ í•„ë“œ ë™ì‹œì— ê°€ì ¸ì˜¤ê¸°)
--
-- Redis Hash êµ¬ì¡°:
-- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
-- â”‚ Key: "fluxgate:api-limits:per-ip:192.168.1.100:per-minute"  â”‚
-- â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
-- â”‚ Field              â”‚ Value                                  â”‚
-- â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
-- â”‚ tokens             â”‚ "30"       â† í˜„ì¬ ë‚¨ì€ í† í°             â”‚
-- â”‚ last_refill_nanos  â”‚ "1703001234000000000" â† ë§ˆì§€ë§‰ ë¦¬í•„ ì‹œê°„ â”‚
-- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

local current_tokens = tonumber(bucket_data[1])      -- "30" â†’ 30
local last_refill_nanos = tonumber(bucket_data[2])   -- "1703001234000000000"

-- ë²„í‚·ì´ ì²˜ìŒ ìƒì„±ë˜ëŠ” ê²½ìš° (nil ì²˜ë¦¬)
if current_tokens == nil or last_refill_nanos == nil then
    current_tokens = capacity  -- 100 (ê°€ë“ ì°¬ ìƒíƒœë¡œ ì‹œì‘)
    last_refill_nanos = current_time_nanos
    -- â†’ ì²˜ìŒ ìš”ì²­í•˜ëŠ” ì‚¬ìš©ìëŠ” ë²„ìŠ¤íŠ¸ í—ˆìš© (100ê°œ í•œë²ˆì— ê°€ëŠ¥)
end
```

**ì‹œê°í™”:**
```
ì²« ë²ˆì§¸ ìš”ì²­ ì‹œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë²„í‚· ì—†ìŒ (nil)     â”‚  â†’  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â”‚      â”‚ tokens = 100 (ê°€ë“!) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ last_refill = now   â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê²½ìš°:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tokens = 30         â”‚  â†’   â”‚ current_tokens = 30 â”‚
â”‚ last_refill = ...   â”‚      â”‚ last_refill = ...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### STEP 5: ê²½ê³¼ ì‹œê°„ ê³„ì‚°

```lua
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- STEP 5: ë§ˆì§€ë§‰ ë¦¬í•„ ì´í›„ ê²½ê³¼ ì‹œê°„ ê³„ì‚°
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local elapsed_nanos = math.max(0, current_time_nanos - last_refill_nanos)
-- math.max(0, ...)ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ :
-- â†’ ë§Œì•½ ì‹œê°„ì´ ìŒìˆ˜ê°€ ë˜ë©´ (Redis ì¬ì‹œì‘ ë“±) 0ìœ¼ë¡œ ì²˜ë¦¬
-- â†’ ìŒìˆ˜ ì‹œê°„ì€ í† í°ì´ ì‚¬ë¼ì§€ëŠ” ë²„ê·¸ ìœ ë°œ!

-- ì˜ˆì‹œ:
-- current_time_nanos  = 1,703,001,294,567,890,000 (ì§€ê¸ˆ)
-- last_refill_nanos   = 1,703,001,234,567,890,000 (60ì´ˆ ì „)
-- elapsed_nanos       = 60,000,000,000 (60ì´ˆ = 600ì–µ ë‚˜ë…¸ì´ˆ)
```

**ì‹œê°í™”:**
```
ì‹œê°„ íë¦„:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     â”‚                                                  â”‚
last_refill                                          now
(ë§ˆì§€ë§‰ ë¦¬í•„)                                       (í˜„ì¬)
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ elapsed_nanos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      (ê²½ê³¼ ì‹œê°„)
```

---

#### STEP 6: ë¦¬í•„í•  í† í° ê³„ì‚° (í•µì‹¬!)

```lua
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- STEP 6: ë¦¬í•„í•  í† í° ìˆ˜ ê³„ì‚° (ì •ìˆ˜ ì—°ì‚°ë§Œ ì‚¬ìš©!)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--
-- Token Bucket ê³µì‹:
-- ë¦¬í•„í•  í† í° = ê²½ê³¼ì‹œê°„ Ã— (ìš©ëŸ‰ / ìœˆë„ìš°)
--
-- í•˜ì§€ë§Œ! ë¶€ë™ì†Œìˆ˜ì  ë¬¸ì œê°€ ìˆìŒ:
--
-- âŒ ë‚˜ìœ ë°©ë²• (ë¶€ë™ì†Œìˆ˜ì ):
--    refill_rate = 100 / 60000000000 = 0.0000000016666...
--    tokens_to_add = elapsed Ã— refill_rate
--    â†’ ì •ë°€ë„ ì†ì‹¤!
--
-- âœ… ì¢‹ì€ ë°©ë²• (ì •ìˆ˜ ì—°ì‚°):
--    tokens_to_add = (elapsed Ã— capacity) / window
--    â†’ ë‚˜ëˆ„ê¸°ë¥¼ ë§ˆì§€ë§‰ì— í•´ì„œ ì •ë°€ë„ ìœ ì§€!

local tokens_to_add = 0
if elapsed_nanos > 0 and window_nanos > 0 then
    tokens_to_add = math.floor((elapsed_nanos * capacity) / window_nanos)
    -- math.floor = ë‚´ë¦¼ (ì†Œìˆ˜ì  ë²„ë¦¼)
end

-- ì˜ˆì‹œ ê³„ì‚°:
-- elapsed_nanos = 30,000,000,000 (30ì´ˆ)
-- capacity      = 100
-- window_nanos  = 60,000,000,000 (60ì´ˆ)
--
-- tokens_to_add = floor((30,000,000,000 Ã— 100) / 60,000,000,000)
--               = floor(3,000,000,000,000,000,000 / 60,000,000,000)
--               = floor(50)
--               = 50ê°œ í† í° ë¦¬í•„!
```

**ì™œ ì •ìˆ˜ ì—°ì‚°ì´ ì¤‘ìš”í•œê°€?**
```
ë¶€ë™ì†Œìˆ˜ì  ë¬¸ì œ ì˜ˆì‹œ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ë°©ë²• A (ë‚˜ì¨ - ë¶€ë™ì†Œìˆ˜ì ):
refill_rate = 100 / 60000000000
            = 0.0000000016666666666666667  â† ë¬´í•œì†Œìˆ˜!

tokens_to_add = 30000000000 * 0.0000000016666666666666667
              = 49.99999999999999...  â† ì •ë°€ë„ ì†ì‹¤!
              â†’ ë°˜ì˜¬ë¦¼í•˜ë©´ 50, ë²„ë¦¼í•˜ë©´ 49 (ë¶ˆì•ˆì •)

ë°©ë²• B (ì¢‹ìŒ - ì •ìˆ˜ ì—°ì‚°):
tokens_to_add = (30000000000 * 100) / 60000000000
              = 3000000000000000000 / 60000000000
              = 50  â† ì •í™•!
```

---

#### STEP 7: í† í° ë¦¬í•„ (ìµœëŒ€ ìš©ëŸ‰ê¹Œì§€ë§Œ)

```lua
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- STEP 7: í† í° ë¦¬í•„ (ìš©ëŸ‰ ì´ˆê³¼ ë°©ì§€)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local new_tokens = math.min(capacity, current_tokens + tokens_to_add)
-- math.min = ë‘˜ ì¤‘ ì‘ì€ ê°’ ì„ íƒ

-- ì˜ˆì‹œ 1: ì •ìƒ ë¦¬í•„
-- current_tokens = 30
-- tokens_to_add  = 50
-- new_tokens     = min(100, 30 + 50) = min(100, 80) = 80 âœ“

-- ì˜ˆì‹œ 2: ì˜¤ë²„í”Œë¡œìš° ë°©ì§€
-- current_tokens = 80
-- tokens_to_add  = 50
-- new_tokens     = min(100, 80 + 50) = min(100, 130) = 100 âœ“
--                  â””â”€ 130ê°œê°€ ë˜ì–´ì•¼ í•˜ì§€ë§Œ 100ê°œë¡œ ì œí•œ!
```

**ì‹œê°í™”:**
```
ë²„í‚· ìƒíƒœ ë³€í™”:

Before (ë¦¬í•„ ì „):                After (ë¦¬í•„ í›„):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—‹â—‹â—‹â—‹â—‹â”‚           â”‚ â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â”‚
â”‚ 30/100 í† í°        â”‚   +50     â”‚ 80/100 í† í°        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”€â”€â”€â”€â–º    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì˜¤ë²„í”Œë¡œìš° ë°©ì§€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—‹â—‹â—‹â—‹â”‚           â”‚ â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â”‚
â”‚ 80/100 í† í°        â”‚   +50     â”‚ 100/100 í† í° (MAX) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”€â”€â”€â”€â–º    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  130ì´ ì•„ë‹Œ 100!
```

---

#### STEP 8: ë¦¬ì…‹ ì‹œê°„ ê³„ì‚°

```lua
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- STEP 8: ë²„í‚·ì´ ê°€ë“ ì°° ë•Œê¹Œì§€ ê±¸ë¦¬ëŠ” ì‹œê°„ ê³„ì‚°
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- (HTTP í—¤ë” X-RateLimit-Resetì— ì‚¬ìš©)

local tokens_until_full = capacity - new_tokens
-- ì˜ˆì‹œ: 100 - 80 = 20ê°œ ë” í•„ìš”

local nanos_until_full = 0
if tokens_until_full > 0 and capacity > 0 then
    nanos_until_full = math.ceil((tokens_until_full * window_nanos) / capacity)
    -- math.ceil = ì˜¬ë¦¼ (ì†Œìˆ˜ì  ì˜¬ë¦¼)
end

-- ì˜ˆì‹œ:
-- tokens_until_full = 20
-- window_nanos      = 60,000,000,000 (60ì´ˆ)
-- capacity          = 100
--
-- nanos_until_full = ceil((20 Ã— 60,000,000,000) / 100)
--                  = ceil(12,000,000,000)
--                  = 12,000,000,000 ë‚˜ë…¸ì´ˆ = 12ì´ˆ

local reset_time_millis = math.floor((current_time_nanos + nanos_until_full) / 1000000)
-- í˜„ì¬ ì‹œê°„ + ë‚¨ì€ ì‹œê°„ â†’ Unix timestamp (ë°€ë¦¬ì´ˆ)
-- ì˜ˆì‹œ: (1703001294567890000 + 12000000000) / 1000000
--     = 1703001306567 (ë°€ë¦¬ì´ˆ)
```

---

#### STEP 9: í† í° ì†Œë¹„ ì‹œë„ (ì„±ê³µ ì¼€ì´ìŠ¤)

```lua
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- STEP 9: í† í° ì†Œë¹„ ì‹œë„
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if new_tokens >= permits then
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- ì„±ê³µ! í† í°ì´ ì¶©ë¶„í•¨
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    new_tokens = new_tokens - permits
    -- ì˜ˆì‹œ: 80 - 1 = 79ê°œ ë‚¨ìŒ

    -- Redisì— ìƒíƒœ ì €ì¥
    redis.call('HMSET', bucket_key,
        'tokens', new_tokens,              -- 79
        'last_refill_nanos', current_time_nanos  -- í˜„ì¬ ì‹œê°„
    )
    -- HMSET = Hash Multi SET (ì—¬ëŸ¬ í•„ë“œ ë™ì‹œì— ì €ì¥)

    -- TTL ì„¤ì • (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
    local desired_ttl_seconds = math.ceil(window_nanos / 1000000000 * 1.1)
    -- ì˜ˆì‹œ: ceil(60 Ã— 1.1) = ceil(66) = 66ì´ˆ
    --       10% ì—¬ìœ ë¥¼ ë‘ëŠ” ì´ìœ : ì‹œê°„ ì˜¤ì°¨ ëŒ€ë¹„

    local actual_ttl_seconds = math.min(desired_ttl_seconds, 86400)
    -- ìµœëŒ€ 24ì‹œê°„(86400ì´ˆ)ìœ¼ë¡œ ì œí•œ (ë„ˆë¬´ ê¸´ TTL ë°©ì§€)

    redis.call('EXPIRE', bucket_key, actual_ttl_seconds)
    -- 66ì´ˆ í›„ ìë™ ì‚­ì œ (ì‚¬ìš© ì•ˆ í•˜ë©´)

    -- ê²°ê³¼ ë°˜í™˜: [í—ˆìš©, ë‚¨ì€í† í°, ëŒ€ê¸°ì‹œê°„, ë¦¬ì…‹ì‹œê°„]
    return {1, new_tokens, 0, reset_time_millis}
    --      â”‚  â”‚           â”‚  â”‚
    --      â”‚  â”‚           â”‚  â””â”€ ë²„í‚·ì´ ê°€ë“ ì°° ë•Œ (Unix ms)
    --      â”‚  â”‚           â””â”€ ëŒ€ê¸° í•„ìš” ì—†ìŒ (ì„±ê³µí–ˆìœ¼ë‹ˆê¹Œ)
    --      â”‚  â””â”€ ë‚¨ì€ í† í° (79ê°œ)
    --      â””â”€ 1 = í—ˆìš©ë¨
```

**ì„±ê³µ ì‹œ Redis ìƒíƒœ:**
```
BEFORE:                              AFTER:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tokens = 30                     â”‚  â”‚ tokens = 79                     â”‚
â”‚ last_refill_nanos = ...         â”‚  â”‚ last_refill_nanos = (now)       â”‚
â”‚ TTL = 40ì´ˆ                      â”‚  â”‚ TTL = 66ì´ˆ (ê°±ì‹ ë¨)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
           +50 ë¦¬í•„ - 1 ì†Œë¹„ = 79
```

---

#### STEP 10: í† í° ì†Œë¹„ ì‹¤íŒ¨ (ê±°ë¶€ ì¼€ì´ìŠ¤)

```lua
else
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- ì‹¤íŒ¨! í† í°ì´ ë¶€ì¡±í•¨
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    local tokens_needed = permits - new_tokens
    -- ì˜ˆì‹œ: permits=1, new_tokens=0 â†’ tokens_needed=1

    local nanos_to_wait = 0
    if capacity > 0 then
        nanos_to_wait = math.ceil((tokens_needed * window_nanos) / capacity)
    end
    -- ì˜ˆì‹œ: ceil((1 Ã— 60,000,000,000) / 100) = 600,000,000 ë‚˜ë…¸ì´ˆ = 0.6ì´ˆ

    -- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    -- â•‘ ì¤‘ìš”: ì‹¤íŒ¨ ì‹œ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ!                  â•‘
    -- â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    -- â•‘ ì´ìœ : ê³µì •ì„± ë³´ì¥                                       â•‘
    -- â•‘                                                         â•‘
    -- â•‘ ë§Œì•½ ì‹¤íŒ¨í•´ë„ ì‹œê°„ì„ ì—…ë°ì´íŠ¸í•˜ë©´:                       â•‘
    -- â•‘ â†’ ê±°ë¶€ëœ ìš”ì²­ì´ ì‹œê°„ì„ ì•ë‹¹ê¹€                            â•‘
    -- â•‘ â†’ ë‹¤ìŒ ìš”ì²­ì´ "ì•„, ë°©ê¸ˆ ë¦¬í•„í–ˆë„¤" ì°©ê°                   â•‘
    -- â•‘ â†’ ì‹¤ì œë¡œëŠ” ë¦¬í•„ ì•ˆ ë¨ â†’ ë¶ˆê³µì •!                          â•‘
    -- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    -- ê²°ê³¼ ë°˜í™˜: [ê±°ë¶€, ë‚¨ì€í† í°, ëŒ€ê¸°ì‹œê°„, ë¦¬ì…‹ì‹œê°„]
    return {0, new_tokens, nanos_to_wait, reset_time_millis}
    --      â”‚  â”‚           â”‚              â”‚
    --      â”‚  â”‚           â”‚              â””â”€ ë²„í‚·ì´ ê°€ë“ ì°° ë•Œ
    --      â”‚  â”‚           â””â”€ 0.6ì´ˆ í›„ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”
    --      â”‚  â””â”€ í˜„ì¬ í† í° (0ê°œ)
    --      â””â”€ 0 = ê±°ë¶€ë¨
end
```

**ê±°ë¶€ ì‹œ ì¤‘ìš”í•œ ì :**
```
âŒ ì˜ëª»ëœ êµ¬í˜„ (ìƒíƒœ ì—…ë°ì´íŠ¸):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ìš”ì²­ A (ê±°ë¶€) â†’ last_refill = now   â† ì´ê±¸ í•˜ë©´ ì•ˆ ë¨!
ìš”ì²­ B (1ì´ˆ í›„) â†’ "1ì´ˆ ì§€ë‚¬ìœ¼ë‹ˆ ë¦¬í•„!" â†’ ì‹¤ì œë¡  ë¦¬í•„ ì•ˆ ë¨

âœ… ì˜¬ë°”ë¥¸ êµ¬í˜„ (ì½ê¸°ë§Œ):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ìš”ì²­ A (ê±°ë¶€) â†’ ìƒíƒœ ì•ˆ ê±´ë“œë¦¼
ìš”ì²­ B (1ì´ˆ í›„) â†’ "ì´ì „ ë¦¬í•„ ê¸°ì¤€ìœ¼ë¡œ 1ì´ˆ ì§€ë‚¨" â†’ ì •í™•í•œ ë¦¬í•„
```

---

#### ì „ì²´ íë¦„ ì‹œê°í™”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Lua ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ íë¦„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ì…ë ¥: bucket_key="user:123", capacity=100, window=60ì´ˆ, permits=1  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Redis TIME ê°€ì ¸ì˜¤ê¸°                                      â”‚   â”‚
â”‚  â”‚    now = 1703001294567890000 ë‚˜ë…¸ì´ˆ                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 2. í˜„ì¬ ìƒíƒœ ì½ê¸° (HMGET)                                   â”‚   â”‚
â”‚  â”‚    tokens = 30, last_refill = 30ì´ˆ ì „                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 3. ë¦¬í•„ ê³„ì‚°                                                â”‚   â”‚
â”‚  â”‚    elapsed = 30ì´ˆ                                           â”‚   â”‚
â”‚  â”‚    tokens_to_add = (30ì´ˆ Ã— 100) / 60ì´ˆ = 50ê°œ               â”‚   â”‚
â”‚  â”‚    new_tokens = min(100, 30+50) = 80ê°œ                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 4. ì†Œë¹„ ê°€ëŠ¥? (80 >= 1)                                     â”‚   â”‚
â”‚  â”‚    â†’ ì˜ˆ! ì„±ê³µ                                               â”‚   â”‚
â”‚  â”‚    â†’ new_tokens = 80 - 1 = 79                               â”‚   â”‚
â”‚  â”‚    â†’ HMSETìœ¼ë¡œ ì €ì¥                                         â”‚   â”‚
â”‚  â”‚    â†’ EXPIREë¡œ TTL ì„¤ì •                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 5. ê²°ê³¼ ë°˜í™˜                                                â”‚   â”‚
â”‚  â”‚    {1, 79, 0, 1703001306567}                                â”‚   â”‚
â”‚  â”‚     â”‚   â”‚  â”‚  â””â”€ 12ì´ˆ í›„ ê°€ë“ ì°¸                            â”‚   â”‚
â”‚  â”‚     â”‚   â”‚  â””â”€ ëŒ€ê¸° ë¶ˆí•„ìš”                                   â”‚   â”‚
â”‚  â”‚     â”‚   â””â”€ 79ê°œ ë‚¨ìŒ                                        â”‚   â”‚
â”‚  â”‚     â””â”€ í—ˆìš©!                                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### Javaì—ì„œ ê²°ê³¼ ì²˜ë¦¬

```java
// RedisTokenBucketStore.java

List<Long> result = connectionProvider.evalsha(sha, keys, args);
// result = [1, 79, 0, 1703001306567]

long consumed = result.get(0);          // 1 (í—ˆìš©)
long remainingTokens = result.get(1);   // 79
long nanosToWait = result.get(2);       // 0
long resetTimeMillis = result.get(3);   // 1703001306567

if (consumed == 1) {
    return BucketState.allowed(remainingTokens, resetTimeMillis);
    // â†’ HTTP 200 OK + í—¤ë” ì¶”ê°€
} else {
    return BucketState.rejected(remainingTokens, nanosToWait, resetTimeMillis);
    // â†’ HTTP 429 Too Many Requests
}
```

**HTTP ì‘ë‹µ í—¤ë”:**
```http
HTTP/1.1 200 OK
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 79
X-RateLimit-Reset: 1703001306
```

ë˜ëŠ” ê±°ë¶€ ì‹œ:
```http
HTTP/1.1 429 Too Many Requests
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1703001306
Retry-After: 1
```

---

### 4.7 ì„¤ê³„ ê²°ì • ë° ì´ìœ 

| ì„¤ê³„ ê²°ì • | ì´ìœ  |
|----------|------|
| **Redis TIME ì‚¬ìš©** | ì„œë²„ë§ˆë‹¤ `System.nanoTime()` ë‹¤ë¦„ â†’ Redis ì‹œê°„ìœ¼ë¡œ í†µì¼ |
| **ì •ìˆ˜ ì—°ì‚°ë§Œ** | ë¶€ë™ì†Œìˆ˜ì ì€ ì •ë°€ë„ ì†ì‹¤ ë°œìƒ |
| **ê±°ë¶€ ì‹œ ìƒíƒœ ì•ˆ ê±´ë“œë¦¼** | ê³µì •í•œ rate limiting (ì„ ì°©ìˆœ ë³´ì¥) |
| **SHA í•´ì‹œ ìºì‹±** | ë§¤ë²ˆ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡ ì•ˆ í•´ë„ ë¨ (ë„¤íŠ¸ì›Œí¬ ì ˆì•½) |
| **TTL ì„¤ì •** | ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ (ì‚¬ìš© ì•ˆ í•˜ëŠ” ë²„í‚· ìë™ ì‚­ì œ) |

---

### 4.8 ë°˜í™˜ ê°’

```lua
return {consumed, remaining_tokens, nanos_to_wait, reset_time_millis}
```

| í•„ë“œ | ì„¤ëª… | ì˜ˆì‹œ |
|------|------|------|
| `consumed` | 1=í—ˆìš©, 0=ê±°ë¶€ | `1` |
| `remaining_tokens` | ë‚¨ì€ í† í° ìˆ˜ | `85` |
| `nanos_to_wait` | ë‹¤ìŒ í† í°ê¹Œì§€ ëŒ€ê¸° ì‹œê°„ | `0` (í—ˆìš© ì‹œ) |
| `reset_time_millis` | ë²„í‚· ë¦¬ì…‹ ì‹œê°„ (Unix timestamp) | `1703001234567` |

ì´ ê°’ë“¤ì€ HTTP ì‘ë‹µ í—¤ë”ë¡œ ë³€í™˜ë©ë‹ˆë‹¤:

```http
X-RateLimit-Remaining: 85
X-RateLimit-Reset: 1703001234
Retry-After: 0
```

---

### 4.9 Cluster ëª¨ë“œ ì§€ì›

```java
// LuaScriptLoader.java:53-55
if (connectionProvider.getMode() == RedisConnectionProvider.RedisMode.CLUSTER) {
  log.info("Script automatically distributed to all cluster master nodes");
}
```

- Lettuceê°€ ìë™ìœ¼ë¡œ ëª¨ë“  ë§ˆìŠ¤í„° ë…¸ë“œì— ìŠ¤í¬ë¦½íŠ¸ ë°°í¬
- `EVALSHA` í˜¸ì¶œ ì‹œ í‚¤ì˜ í•´ì‹œ ìŠ¬ë¡¯ì— ë”°ë¼ ì˜¬ë°”ë¥¸ ë…¸ë“œë¡œ ë¼ìš°íŒ…

---

## ê´€ë ¨ ë¬¸ì„œ

- [Engine Layer Deep Dive](engine-layer.ko.md)
- [Storage Layer Deep Dive](storage-layer.ko.md)
- [ì•„í‚¤í…ì²˜ ê°œìš”](../README.ko.md)
