server:
  port: 8085

spring:
  application:
    name: fluxgate-sample-standalone

# FluxGate Configuration
fluxgate:
  # MongoDB configuration (uses FluxgateMongoAutoConfiguration)
  mongo:
    enabled: true
    uri: mongodb://fluxgate:fluxgate123@localhost:27017/fluxgate?authSource=admin
    database: fluxgate
    rule-collection: rate_limit_rules
    # Optional: Enable event logging by setting event-collection
    event-collection: rate_limit_events
    # DDL auto mode: validate (default) or create
    ddl-auto: validate
  # Redis configuration (uses FluxgateConfig)
  redis:
    enabled: true
    # Connection mode: auto (default), standalone, or cluster
    # - auto: Auto-detect from URI (single = standalone, comma-separated = cluster)
    # - standalone: Force standalone mode
    # - cluster: Force cluster mode
    mode: auto
    uri: redis://127.0.0.1:7100,redis://127.0.0.1:7101,redis://127.0.0.1:7102
    #uri: redis://localhost:6379
  # Metrics enable for Prometheus
  metrics:
    enabled: true

  # Resilience configuration
  resilience:
    retry:
      enabled: true
      max-attempts: 3
      initial-backoff: 100ms
      multiplier: 2.0
      max-backoff: 2s
    circuit-breaker:
      enabled: false  # Enable if you want circuit breaker protection
      failure-threshold: 5
      wait-duration-in-open-state: 30s
      permitted-calls-in-half-open-state: 3
      fallback: FAIL_OPEN

# Logging
  # Rate limiting behavior configuration
  ratelimit:
    enabled: true
    # Behavior when no matching rule is found: ALLOW (default) or DENY
    # DENY: Strict mode - reject requests if no rule exists (fail-closed)
    # ALLOW: Permissive mode - allow requests if no rule exists
    missing-rule-behavior: ALLOW

  # Hot reload configuration
  reload:
    enabled: true
    strategy: PUBSUB  # Use Redis Pub/Sub for real-time updates
    pubsub:
      channel: fluxgate:rule-reload  # Must match Admin API channel

logging:
  level:
    org.fluxgate: DEBUG
    org.fluxgate.sample.standalone: DEBUG
    root: info

# Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics,conditions
  endpoint:
    health:
      show-details: always
      show-components: always
    prometheus:
      enabled: true

# Swagger/OpenAPI
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    tags-sorter: alpha
    operations-sorter: alpha

---
# Docker profile (when running with docker-compose)
spring:
  config:
    activate:
      on-profile: docker

fluxgate:
  mongo:
    enabled: true
    uri: mongodb://fluxgate:fluxgate123@mongodb:27017/fluxgate?authSource=admin
    rule-collection: rate_limit_rules
    event-collection: rate_limit_events
    ddl-auto: create
  redis:
    uri: redis://127.0.0.1:7100,redis://127.0.0.1:7101,redis://127.0.0.1:7102
    #uri: redis://redis:6379
  resilience:
    retry:
      enabled: true
      max-attempts: 5
      initial-backoff: 200ms
    circuit-breaker:
      enabled: true
      failure-threshold: 5
      wait-duration-in-open-state: 30s
      fallback: FAIL_OPEN
